<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="追风少年" type="application/atom+xml">






<meta name="description" content="选择，机会，勤奋，积极">
<meta name="keywords" content="爱我所爱">
<meta property="og:type" content="website">
<meta property="og:title" content="追风少年">
<meta property="og:url" content="hjx051013.github.io/index.html">
<meta property="og:site_name" content="追风少年">
<meta property="og:description" content="选择，机会，勤奋，积极">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="追风少年">
<meta name="twitter:description" content="选择，机会，勤奋，积极">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="hjx051013.github.io/">





  <title>追风少年</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband">
      <a href="https://github.com/hjx051013" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    </div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">追风少年</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Code is poetry</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="hjx051013.github.io/2019/09/06/redis配置项说明/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jiaxinhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追风少年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/06/redis配置项说明/" itemprop="url">redis配置项说明</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-06T13:57:24+08:00">
                2019-09-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/09/06/redis配置项说明/" class="leancloud_visitors" data-flag-title="redis配置项说明">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
                <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>redis.conf 配置项说明如下：</p>
<ol>
<li><p>Redis默认不是以守护进程的方式运行，可以通过该配置项修改，使用yes启用守护进程</p>
<p> daemonize no</p>
</li>
<li><p>当Redis以守护进程方式运行时，Redis默认会把pid写入/var/run/redis.pid文件，可以通过pidfile指定</p>
<p> pidfile /var/run/redis.pid</p>
</li>
<li><p>指定Redis监听端口，默认端口为6379，作者在自己的一篇博文中解释了为什么选用6379作为默认端口，因为6379在手机按键上MERZ对应的号码，而MERZ取自意大利歌女Alessia Merz的名字</p>
<p> port 6379</p>
</li>
<li><p>绑定的主机地址</p>
<p> bind 127.0.0.1</p>
</li>
</ol>
<p>5.当 客户端闲置多长时间后关闭连接，如果指定为0，表示关闭该功能  </p>
<pre><code> timeout 300
</code></pre><ol>
<li><p>指定日志记录级别，Redis总共支持四个级别：debug、verbose、notice、warning，默认为verbose</p>
<p> loglevel verbose</p>
</li>
<li><p>日志记录方式，默认为标准输出，如果配置Redis为守护进程方式运行，而这里又配置为日志记录方式为标准输出，则日志将会发送给/dev/null</p>
<p> logfile stdout</p>
</li>
<li><p>设置数据库的数量，默认数据库为0，可以使用SELECT <dbid>命令在连接上指定数据库id</dbid></p>
<p> databases 16</p>
</li>
<li><p>指定在多长时间内，有多少次更新操作，就将数据同步到数据文件，可以多个条件配合</p>
<p> save <seconds> <changes></changes></seconds></p>
<p> Redis默认配置文件中提供了三个条件：</p>
<p> save 900 1</p>
<p> save 300 10</p>
<p> save 60 10000</p>
<p> 分别表示900秒（15分钟）内有1个更改，300秒（5分钟）内有10个更改以及60秒内有10000个更改。</p>
</li>
</ol>
<ol>
<li><p>指定存储至本地数据库时是否压缩数据，默认为yes，Redis采用LZF压缩，如果为了节省CPU时间，可以关闭该选项，但会导致数据库文件变的巨大</p>
<p>rdbcompression yes</p>
</li>
<li><p>指定本地数据库文件名，默认值为dump.rdb</p>
<p>dbfilename dump.rdb</p>
</li>
<li><p>指定本地数据库存放目录</p>
<p>dir ./</p>
</li>
<li><p>设置当本机为slav服务时，设置master服务的IP地址及端口，在Redis启动时，它会自动从master进行数据同步</p>
<p>slaveof <masterip> <masterport></masterport></masterip></p>
</li>
<li><p>当master服务设置了密码保护时，slav服务连接master的密码</p>
<p>masterauth <master-password></master-password></p>
</li>
<li><p>设置Redis连接密码，如果配置了连接密码，客户端在连接Redis时需要通过AUTH <password>命令提供密码，默认关闭</password></p>
<p>requirepass foobared</p>
</li>
<li><p>设置同一时间最大客户端连接数，默认无限制，Redis可以同时打开的客户端连接数为Redis进程可以打开的最大文件描述符数，如果设置 maxclients 0，表示不作限制。当客户端连接数到达限制时，Redis会关闭新的连接并向客户端返回max number of clients reached错误信息</p>
<p>maxclients 128</p>
</li>
<li><p>指定Redis最大内存限制，Redis在启动时会把数据加载到内存中，达到最大内存后，Redis会先尝试清除已到期或即将到期的Key，当此方法处理 后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作。Redis新的vm机制，会把Key存放内存，Value会存放在swap区</p>
<p>maxmemory <bytes></bytes></p>
</li>
<li><p>指定是否在每次更新操作后进行日志记录，Redis在默认情况下是异步的把数据写入磁盘，如果不开启，可能会在断电时导致一段时间内的数据丢失。因为 redis本身同步数据文件是按上面save条件来同步的，所以有的数据会在一段时间内只存在于内存中。默认为no</p>
<p>appendonly no</p>
</li>
<li><p>指定更新日志文件名，默认为appendonly.aof</p>
<p> appendfilename appendonly.aof</p>
</li>
<li><p>指定更新日志条件，共有3个可选值：<br>no：表示等操作系统进行数据缓存同步到磁盘（快）<br>always：表示每次更新操作后手动调用fsync()将数据写到磁盘（慢，安全）<br>everysec：表示每秒同步一次（折衷，默认值）</p>
<p>appendfsync everysec</p>
</li>
</ol>
<ol>
<li><p>指定是否启用虚拟内存机制，默认值为no，简单的介绍一下，VM机制将数据分页存放，由Redis将访问量较少的页即冷数据swap到磁盘上，访问多的页面由磁盘自动换出到内存中（在后面的文章我会仔细分析Redis的VM机制）</p>
<p> vm-enabled no</p>
</li>
<li><p>虚拟内存文件路径，默认值为/tmp/redis.swap，不可多个Redis实例共享</p>
<p> vm-swap-file /tmp/redis.swap</p>
</li>
<li><p>将所有大于vm-max-memory的数据存入虚拟内存,无论vm-max-memory设置多小,所有索引数据都是内存存储的(Redis的索引数据 就是keys),也就是说,当vm-max-memory设置为0的时候,其实是所有value都存在于磁盘。默认值为0</p>
<p> vm-max-memory 0</p>
</li>
<li><p>Redis swap文件分成了很多的page，一个对象可以保存在多个page上面，但一个page上不能被多个对象共享，vm-page-size是要根据存储的 数据大小来设定的，作者建议如果存储很多小对象，page大小最好设置为32或者64bytes；如果存储很大大对象，则可以使用更大的page，如果不 确定，就使用默认值</p>
<p> vm-page-size 32</p>
</li>
<li><p>设置swap文件中的page数量，由于页表（一种表示页面空闲或使用的bitmap）是在放在内存中的，，在磁盘上每8个pages将消耗1byte的内存。</p>
<p> vm-pages 134217728</p>
</li>
<li><p>设置访问swap文件的线程数,最好不要超过机器的核数,如果设置为0,那么所有对swap文件的操作都是串行的，可能会造成比较长时间的延迟。默认值为4</p>
<p> vm-max-threads 4</p>
</li>
<li><p>设置在向客户端应答时，是否把较小的包合并为一个包发送，默认为开启</p>
<p>glueoutputbuf yes</p>
</li>
<li><p>指定在超过一定的数量或者最大的元素超过某一临界值时，采用一种特殊的哈希算法</p>
<p>hash-max-zipmap-entries 64</p>
<p>hash-max-zipmap-value 512</p>
</li>
<li><p>指定是否激活重置哈希，默认为开启（后面在介绍Redis的哈希算法时具体介绍）</p>
<p>activerehashing yes</p>
</li>
<li><p>指定包含其它的配置文件，可以在同一主机上多个Redis实例之间使用同一份配置文件，而同时各个实例又拥有自己的特定配置文件</p>
<p>include /path/to/local.conf</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="hjx051013.github.io/2019/09/06/理解epoll/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jiaxinhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追风少年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/06/理解epoll/" itemprop="url">理解epoll</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-06T13:55:09+08:00">
                2019-09-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/IO多路复用/" itemprop="url" rel="index">
                    <span itemprop="name">IO多路复用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/09/06/理解epoll/" class="leancloud_visitors" data-flag-title="理解epoll">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
                <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  6
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>epoll模型是在单个线程中侦听多个套接字fd行为的一种IO多路复用模型。主要有<code>epoll_create</code>,<code>epoll_ctl</code>,<code>epoll_wait</code>三个接口。</p>
<h3 id="一、epoll的使用"><a href="#一、epoll的使用" class="headerlink" title="一、epoll的使用"></a>一、epoll的使用</h3><h4 id="1-创建epoll句柄"><a href="#1-创建epoll句柄" class="headerlink" title="1. 创建epoll句柄"></a>1. 创建epoll句柄</h4><blockquote>
<p> int epfd = epoll_create(intsize);<br>创建一个epoll的句柄，size用来告诉内核这个监听的数目一共有多大。size就是你在这个epoll fd上能关注的最大socket fd数。</p>
</blockquote>
<h4 id="2-将被监听的描述符添加到epoll句柄或从epool句柄中删除或者对监听事件进行修改。"><a href="#2-将被监听的描述符添加到epoll句柄或从epool句柄中删除或者对监听事件进行修改。" class="headerlink" title="2.将被监听的描述符添加到epoll句柄或从epool句柄中删除或者对监听事件进行修改。"></a>2.将被监听的描述符添加到epoll句柄或从epool句柄中删除或者对监听事件进行修改。</h4><blockquote>
<p>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event)<br>参数：<br>epfd：由 epoll_create 生成的epoll专用的文件描述符；<br>op：要进行的操作例如注册事件，可能的取值EPOLL_CTL_ADD 注册、EPOLL_CTL_MOD 修 改、EPOLL_CTL_DEL 删除<br>fd：关联的文件描述符；<br>event：指向epoll_event的指针；<br>如果调用成功返回0,不成功返回-1</p>
</blockquote>
<p>第一个参数是epoll_create()的返回值，<br>第二个参数表示动作，用三个宏来表示：</p>
<ul>
<li>EPOLL_CTL_ADD：       注册新的fd到epfd中；</li>
<li>EPOLL_CTL_MOD：      修改已经注册的fd的监听事件；</li>
<li>EPOLL_CTL_DEL：        从epfd中删除一个fd；<br>第三个参数是需要监听的fd，<br>第四个参数是告诉内核需要监听什么事件，structepoll_event结构如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">typedef union epoll_data &#123;</span><br><span class="line">void *ptr; //指向要附加的数据结构</span><br><span class="line">int fd;     //一般设为监视的fd</span><br><span class="line">__uint32_t u32;</span><br><span class="line">__uint64_t u64;</span><br><span class="line">&#125; epoll_data_t;</span><br><span class="line"></span><br><span class="line">struct epoll_event &#123;</span><br><span class="line">/* Epoll events</span><br><span class="line">events可以是以下几个宏的集合：</span><br><span class="line">         EPOLLIN：            触发该事件，表示对应的文件描述符上有可读数据。(包括对端SOCKET正常关闭)；</span><br><span class="line">         EPOLLOUT：         触发该事件，表示对应的文件描述符上可以写数据；</span><br><span class="line">        EPOLLPRI：           表示对应的文件描述符有紧急的数据可读（这里应该表示有带外数据到来）；</span><br><span class="line">        EPOLLERR：        表示对应的文件描述符发生错误；</span><br><span class="line">         EPOLLHUP：        表示对应的文件描述符被挂断；</span><br><span class="line">        EPOLLET：           将EPOLL设为边缘触发(Edge Triggered)模式，这是相对于水平触发(Level Triggered)来说的。</span><br><span class="line">        EPOLLONESHOT：  只监听一次事件，当监听完这次事件之后，如果还需要继续监听这个socket的话，需要再次把这个socket加入到EPOLL队列里。</span><br><span class="line"> */</span><br><span class="line">__uint32_t events; </span><br><span class="line">epoll_data_t data; /* User data variable */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>如要监听服务端套接字的连接，listenfd对对应的socket套接字，之前已经bind和listen好。将它加入到epfd指定的epoll对象中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct epoll_event ev;</span><br><span class="line">//设置与要处理的事件相关的文件描述符</span><br><span class="line">ev.data.fd=listenfd;</span><br><span class="line">//设置要处理的事件类型</span><br><span class="line">ev.events=EPOLLIN|EPOLLET;</span><br><span class="line">//注册epoll事件</span><br><span class="line">epoll_ctl(epfd,EPOLL_CTL_ADD,listenfd,&amp;ev);</span><br></pre></td></tr></table></figure></p>
<h4 id="3-等待事件触发，当超过timeout还没有事件触发时，就超时。"><a href="#3-等待事件触发，当超过timeout还没有事件触发时，就超时。" class="headerlink" title="3.等待事件触发，当超过timeout还没有事件触发时，就超时。"></a>3.等待事件触发，当超过timeout还没有事件触发时，就超时。</h4><blockquote>
<p>int epoll_wait(int epfd, struct epoll_event <em> events, intmaxevents, int timeout);<br>函数声明:int epoll_wait(int epfd,struct epoll_event </em> events,int maxevents,int timeout)<br>该函数用于轮询I/O事件的发生；参数：<br>epfd:由epoll_create 生成的epoll专用的文件描述符；<br>epoll_event:用于回传代处理事件的数组，已经分配好内存；<br>maxevents:每次能处理的最大事件数；<br>timeout:等待I/O事件发生的超时值(单位我也不太清楚)；-1相当于阻塞，0相当于非阻塞。一般用-1即可<br>返回发生事件数。</p>
</blockquote>
<h3 id="二、epoll的原理"><a href="#二、epoll的原理" class="headerlink" title="二、epoll的原理"></a>二、epoll的原理</h3><p>本节会以示例和图表来讲解epoll的原理和流程。</p>
<h4 id="1-创建epoll对象"><a href="#1-创建epoll对象" class="headerlink" title="1.创建epoll对象"></a>1.创建epoll对象</h4><p>如下图所示，当某个进程调用epoll_create方法时，内核会创建一个eventpoll对象（也就是程序中epfd所代表的对象）。eventpoll对象也是文件系统中的一员，和socket一样，它也会有等待队列。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13261459-c3ee8c3e009c2283?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="内核创建eventpoll对象"></p>
<p>创建一个代表该epoll的eventpoll对象是必须的，因为内核要维护“就绪列表”等数据，“就绪列表”可以作为eventpoll的成员。</p>
<h4 id="2-维护监视列表"><a href="#2-维护监视列表" class="headerlink" title="2.维护监视列表"></a>2.维护监视列表</h4><p>创建epoll对象后，可以用epoll_ctl添加或删除所要监听的socket。以添加socket为例，如下图，如果通过epoll_ctl添加sock1、sock2和sock3的监视，内核会将eventpoll添加到这三个socket的等待队列中。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13261459-61511732224c16c5?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="添加所要监听的socket"><br>当socket收到数据后，中断程序会操作eventpoll对象，而不是直接操作进程。</p>
<h4 id="3-接收数据"><a href="#3-接收数据" class="headerlink" title="3.接收数据"></a>3.接收数据</h4><p>当socket收到数据后，中断程序会给eventpoll的“就绪列表”添加socket引用。如下图展示的是sock2和sock3收到数据后，中断程序让rdlist引用这两个socket。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13261459-83c76dad3e65d683?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="给就绪列表添加引用"></p>
<p>eventpoll对象相当于是socket和进程之间的中介，socket的数据接收并不直接影响进程，而是通过改变eventpoll的就绪列表来改变进程状态。</p>
<p>当程序执行到epoll_wait时，如果rdlist已经引用了socket，那么epoll_wait直接返回，如果rdlist为空，阻塞进程。</p>
<h4 id="4-阻塞和唤醒进程"><a href="#4-阻塞和唤醒进程" class="headerlink" title="4.阻塞和唤醒进程"></a>4.阻塞和唤醒进程</h4><p>假设计算机中正在运行进程A和进程B，在某时刻进程A运行到了epoll_wait语句。如下图所示，内核会将进程A放入eventpoll的等待队列中，阻塞进程。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13261459-f3c0cccf9a288894?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="epoll_wait阻塞进程"></p>
<p>当socket接收到数据，中断程序一方面修改rdlist，另一方面唤醒eventpoll等待队列中的进程，进程A再次进入运行状态（如下图）。也因为rdlist的存在，进程A可以知道哪些socket发生了变化。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13261459-b87afc2b79e68b7f?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="epoll唤醒进程"></p>
<h3 id="三、epoll的实现细节"><a href="#三、epoll的实现细节" class="headerlink" title="三、epoll的实现细节"></a>三、epoll的实现细节</h3><p>读完这篇文章，还有三个问题需要细究一下。</p>
<ol>
<li>eventpoll的数据结构是什么样子？</li>
<li>就绪队列应该应使用什么数据结构？</li>
<li>eventpoll应使用什么数据结构来管理通过epoll_ctl添加或删除的socket？</li>
</ol>
<hr>
<p>如下图所示，eventpoll包含了lock、mtx、wq（等待队列）、rdlist等成员。rdlist和rbr是我们所关心的。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/13261459-7570f09a2a7a588f?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="epoll原理示意图"></p>
<h4 id="1-就绪列表的数据结构"><a href="#1-就绪列表的数据结构" class="headerlink" title="1. 就绪列表的数据结构"></a>1. 就绪列表的数据结构</h4><ul>
<li>就绪列表引用着就绪的socket，所以它应能够快速的插入数据。</li>
<li>程序可能随时调用epoll_ctl添加监视socket，也可能随时删除。当删除时，若该socket已经存放在就绪列表中，它也应该被移除。</li>
</ul>
<p>所以就绪列表应是一种能够快速插入和删除的数据结构。双向链表就是这样一种数据结构，epoll使用双向链表来实现就绪队列（对应上图的rdllist）。</p>
<h4 id="2-索引结构"><a href="#2-索引结构" class="headerlink" title="2.索引结构"></a>2.索引结构</h4><p>既然epoll将“维护监视队列”和“进程阻塞”分离，也意味着需要有个数据结构来保存监视的socket。至少要方便的添加和移除，还要便于搜索，以避免重复添加。红黑树是一种自平衡二叉查找树，搜索、插入和删除时间复杂度都是O(log(N))，效率较好。epoll使用了红黑树作为索引结构（对应上图的rbr），存储所监视的socket fd。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="hjx051013.github.io/2019/09/06/海量数据处理问题/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jiaxinhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追风少年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/06/海量数据处理问题/" itemprop="url">海量数据处理问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-06T13:53:51+08:00">
                2019-09-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/大数据/" itemprop="url" rel="index">
                    <span itemprop="name">大数据</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/09/06/海量数据处理问题/" class="leancloud_visitors" data-flag-title="海量数据处理问题">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
                <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  1.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  5
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、方法论"><a href="#一、方法论" class="headerlink" title="一、方法论"></a>一、方法论</h2><ol>
<li>对于固定大小的海量数据，通常可以采用分文件+哈希统计+内存处理（堆/快速/归并排序）的方法。</li>
</ol>
<ul>
<li>对于字符串数据，可以对字符串进行哈希，哈希值%n(n为分文件数量)，这样来说同一个字符串必然分配到一个文件当中，然后如果哈希均匀的话，就能够保证每个文件可以放入内存当中，在内存当中采用通用方法进行处理获得每个文件的结果，然后写到磁盘中，最后汇总或者直接在内存中汇总。</li>
<li>对于数字，可以直接x%n（n为分文件数量）或者采用二进制前k位来分成2^k个文件块。</li>
</ul>
<ol>
<li>Bloom filter(布隆过滤器)<ul>
<li>判断一条记录在另一个记录集合中是否存在。具体操作时，对于记录集合S中的n条记录，设置m位的bitmap和k个独立hash函数，遍历S集合，对于每条记录，将其k个hash函数值对应位置1。要判断一条记录是否存在时，查看其k个hash函数值对应位是否都是1，如果是，就认为存在，否则就不存在。bloom filter对于有hash函数值为0的，那么就可以100%确定这条记录不存在，但是可能把不存在的误判成存在的。但是这样的概率很小。</li>
<li>m应该&gt;=nlg(1/E)<em>lge 大概就是nlg(1/E)1.44倍，当hash函数个数k=(ln2)</em>(m/n)时错误率最小。</li>
<li>Counting bloom filter（CBF）将位数组中的每一位扩展为一个counter，从而支持了元素的删除操作。counter可以记录hash值对应到该counter的次数</li>
</ul>
<ol>
<li>bitmap</li>
</ol>
<ul>
<li>对于uint32型的数据比较有用，uint32每个数字对应一位，最后会申请512M的内存。</li>
</ul>
<ol>
<li>Trie树（前缀树）</li>
</ol>
</li>
</ol>
<ul>
<li>适用范围：数据量大，重复多，但是数据种类小可以放入内存。</li>
<li>基本原理及要点：实现方式，节点孩子的表示方式</li>
<li>扩展：压缩实现。</li>
</ul>
<ol>
<li>外排序<ul>
<li>外部排序是针对海量数据无法放入内存中排序而产生的一种排序算法。基本算法是拆分成多个小文件，每个小文件可以放入内存当中，对于小文件进行排序后，再采用多路归并排序，也就是构造一个大小为文件块数的堆（升序就是小堆，降序就是最大堆），先分别从k个文件中读取一个数插入堆中，将堆顶元素写到文件中，然后从写出元素所在文件中再读入一个数，依次进行下去。</li>
<li>适用范围：大数据的排序，去重<h2 id="面试问题："><a href="#面试问题：" class="headerlink" title="面试问题："></a>面试问题：</h2></li>
</ul>
<ol>
<li>海量日志数据，提取出某日访问百度次数最多的那个IP。</li>
</ol>
</li>
</ol>
<ul>
<li>方法一:<ol>
<li>分而治之/哈希映射：读取ip，划分成n个文件根据hashCode%n值，分划到相应的文件当中</li>
<li>哈希统计：对于每个文件，可以读入内存，hashmap统计ip次数（注意一个ip只会出现在一个文件当中），然后通过排序或者遍历获得最大次数的ip。</li>
<li>汇总：获得每个文件中出现次数最多的ip，进行堆排或者快排或者扫描，就可以获得出现次数最多的ip。</li>
</ol>
</li>
<li>方法二：<br>  trie树，用第k叉表示ip的一部分（ip可以分为四部分）。叶结点值可以存放ip次数。<ol>
<li>寻找热门查询，300万个查询字符串中统计最热门的10个查询<br>300万个字符串如果可以放进内存存储为hashmap，那么就不用分而治之/哈希映射了。<br>哈希统计：hashmap统计每个字符串出现次数<br>堆排序：简历大小为10的小顶堆，堆元素为键值对，键为字符串，值为字符串出现次数，遍历hasmap或者读入文件流，遇到键值对的值大于堆顶元素值，就插入堆，并且删除堆顶键值对。遍历完毕后就可以获得top k查询结果。<br>trie树加大小为10的最小堆的方法也能够解决</li>
<li>在10G数据中，数据类型为uint32，内存1G，寻找其中重复出现的数字<br>方法一、分而治之/哈希映射：根据uint32前4位将数据分成2^4个文件块<br>哈希统计：hashmap统计每个文件块中重复出现的数字<br>汇总：将每个文件快重复出现的数字直接并起来<br>方法二、 bitmap<br>uint32为2^32次方，对于每个数用一个bit记录是否出现，如果出现，就置该bit为1，如果发现该bit位已经为1，那么就直接将该数写到文件中，说明已经出现过。这种方法效率很高，但是如果可用内存更小或者改成uint64，那么就不行了。</li>
<li>海量数据分布在100台电脑中，想个办法高效统计出这批数据的TOP10。</li>
</ol>
<ul>
<li>如果每个数据只在一台电脑上出现，那么求出每台电脑的TOP10，再进行汇总。</li>
<li>遍历一遍所有数据，重新hash取摸，如此使得同一个元素只出现在单独的一台电脑中，然后采用上面所说的方法，统计每台电脑中各个元素的出现次数找出TOP10，继而组合100台电脑上的TOP10，找出最终的TOP10。</li>
<li>或者，暴力求解：直接统计统计每台电脑中各个元素的出现次数，然后把同一个元素在不同机器中的出现次数相加，最终从所有数据中找出TOP10。</li>
</ul>
</li>
</ul>
<ol>
<li>给定a、b两个文件，各存放50亿个url，每个url各占64字节，内存限制是4G，让你找出a、b文件共同的url？<br>将a,b两个文件中的url经哈希分散到a[1000]个子文件中和b[1000]子文件中后，文件$a_i$与$b_i$放入内存取交集即可。</li>
<li>怎么在海量数据中找出重复次数最多的一个？<br>先做hash，然后求模映射为小文件，求出每个小文件中重复次数最多的一个,然后求所有文件中最大的重复次数。<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2>对于固定大小的海量数据，通用做法就是分文件hash+内存处理（堆/快速/归并排序）+汇总方法解决。可以一次性放进内存中处理的做法有bitmap，trie树。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="hjx051013.github.io/2019/09/06/批量迁移markdown文件图片到云存储中/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jiaxinhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追风少年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/09/06/批量迁移markdown文件图片到云存储中/" itemprop="url">批量迁移markdown文件图片到云存储中</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-09-06T01:43:24+08:00">
                2019-09-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/09/06/批量迁移markdown文件图片到云存储中/" class="leancloud_visitors" data-flag-title="批量迁移markdown文件图片到云存储中">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
                <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="批量迁移markdown文档到云存储中"><a href="#批量迁移markdown文档到云存储中" class="headerlink" title="批量迁移markdown文档到云存储中"></a>批量迁移markdown文档到云存储中</h1><p>之前一直为撰写md文档的图片问题感到苦恼，要么存在本地但是文档想要整体迁移到网上就很麻烦，要么就得往文档中插入插入图片就得传到云端费时费力。于是感觉到写一个python脚本一劳永逸地解决这个问题的必要性。</p>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><ul>
<li>通过类似于<code>python srcipt md_file/directory</code>的命令整体将指定md文档或者指定文件夹下的所有md文档中的图片整体从其他网址或本地相对/绝对路径迁移到指定的云存储中</li>
<li>通过默认或者指定配置文件来支持多种类型的云存储</li>
<li>支持图片压缩</li>
<li>目前支持七牛云和又拍云云存储</li>
</ul>
<h2 id="整体的代码流程"><a href="#整体的代码流程" class="headerlink" title="整体的代码流程"></a>整体的代码流程</h2><p>   <img src="http://hjx-markdown-images.test.upcdn.net/2019/09/06/4a9e1b1bb6800b8179c51f2140f5b42b.png" alt="切换md图片流程图.png">)</p>
<h2 id="预备环境"><a href="#预备环境" class="headerlink" title="预备环境"></a>预备环境</h2><ul>
<li><p>python3</p>
</li>
<li><p>依赖库, <code>pip install -r requirements.txt</code>安装所有依赖库</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">qiniu</span><br><span class="line">certifi==2019.6.16</span><br><span class="line">chardet==3.0.4</span><br><span class="line">decorator==4.4.0</span><br><span class="line">idna==2.8</span><br><span class="line">requests==2.22.0</span><br><span class="line">six==1.12.0</span><br><span class="line">tinify==1.5.1</span><br><span class="line">upyun==2.5.2</span><br><span class="line">urllib3==1.25.3</span><br><span class="line">validators==0.14.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果实在类unix系统中，可在家目录下新建<code>.md.mdPicTransfer.cfg</code>文件，用于配置云存储。格式如下：</p>
<ul>
<li>三个配置大项。<code>common</code>,<code>upai</code>,<code>qiniu</code>分别对应基础配置，又拍云配置，七牛云配置</li>
<li>upai下面是又拍云上传文件所需要的基本配置</li>
<li>qiniu下面是七牛云上传文件所需要的基本配置</li>
</ul>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">option=upai/qiniu</span><br><span class="line">tinypngkey=xxx</span><br><span class="line">[upai]</span><br><span class="line">servicename=xxx</span><br><span class="line">operatorname=xxx</span><br><span class="line">password=xxx</span><br><span class="line">domain=xxx</span><br><span class="line">[qiniu]</span><br><span class="line">accesskey=xxx</span><br><span class="line">secretkey=xxx</span><br><span class="line">bucketname=xxx</span><br><span class="line">domain=xxx</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>获得代码</p>
<ol>
<li>将下面源码所列的四个文件放在一个文件夹中，按照提示运行程序迁移指定md文档或指定文件夹的所有md文档中的图片到云存储中。</li>
<li>从<a href="">此仓库</a>克隆代码下来到本地，<code>pip install -r requirements.txt</code>安装所有依赖库，按照提示运行程序。</li>
</ol>
</li>
</ul>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>   <strong>picUploader.py</strong>, 主文件</p>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"><span class="keyword">import</span> imghdr</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> tinify</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> validators</span><br><span class="line"><span class="keyword">import</span> getopt</span><br><span class="line"><span class="keyword">import</span> configparser</span><br><span class="line"><span class="keyword">from</span> QiniuYun <span class="keyword">import</span> Qiniu</span><br><span class="line"><span class="keyword">from</span> UpYun <span class="keyword">import</span> Upai</span><br><span class="line"></span><br><span class="line">md_loc = <span class="string">''</span>  <span class="comment"># md地址</span></span><br><span class="line">need_zip = <span class="keyword">False</span></span><br><span class="line">os_name = <span class="string">''</span></span><br><span class="line">need_cache = <span class="keyword">False</span></span><br><span class="line">today = datetime.date.today()</span><br><span class="line">yyyymmdd = today.strftime(<span class="string">'%Y%m%d'</span>)  <span class="comment"># 创建时间变量，用于图片起名</span></span><br><span class="line">total, success, failure, ignore = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">cloud_cfg = <span class="keyword">None</span></span><br><span class="line">need_back = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">(upload_file_name)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    根据给定的图片名上传图片，并返回图片地址和一些上传信息</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">global</span> success, failure</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 上传到云存储后的图片名:上传日期-MD文件名/image序号.png or jpg</span></span><br><span class="line">    key = yyyymmdd + <span class="string">"_"</span> + os.path.splitext(os.path.basename(sys.argv[<span class="number">1</span>]))[<span class="number">0</span>] + <span class="string">"/image"</span> + (<span class="string">'&#123;0&#125;'</span>.format(success + <span class="number">1</span>)) + \</span><br><span class="line">          os.path.splitext(upload_file_name)[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        upload_url = cloud_cfg.upload_file(upload_file_name, key, <span class="keyword">False</span>)</span><br><span class="line">        <span class="keyword">if</span> upload_url:</span><br><span class="line">            success = success + <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> upload_url</span><br><span class="line">        failure = failure + <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"异常："</span>, e)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">transfer_online_img</span><span class="params">(old_link)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    根据给定的图片链接上传图片到云存储，并返回图片地址和一些上传信息</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">global</span> success, ignore, failure</span><br><span class="line">    <span class="keyword">if</span> validators.url(old_link) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">True</span>:</span><br><span class="line">        ignore = ignore + <span class="number">1</span></span><br><span class="line">        print(<span class="string">'invalid url, ignore'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># maybe a url</span></span><br><span class="line">    <span class="comment"># already from qiniu</span></span><br><span class="line">    <span class="keyword">if</span> old_link.find(cloud_cfg.domain) != <span class="number">-1</span>:</span><br><span class="line">        ignore = ignore + <span class="number">1</span></span><br><span class="line">        print(<span class="string">'already in target cloud, ignore'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># omit the query string section like:?arg1=val1&amp;arg2=val2 in the url</span></span><br><span class="line">    <span class="keyword">if</span> old_link.find(<span class="string">'?'</span>) != <span class="number">-1</span>:</span><br><span class="line">        old_link = old_link[: old_link.index(<span class="string">'?'</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 上传到云存储后的图片名:上传日期-MD文件名/image序号</span></span><br><span class="line">    key = yyyymmdd + <span class="string">"_"</span> + os.path.splitext(os.path.basename(sys.argv[<span class="number">1</span>]))[<span class="number">0</span>] + <span class="string">"/image"</span> + (<span class="string">'&#123;0&#125;'</span>.format(success + <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        upload_url = cloud_cfg.upload_file(old_link, key, <span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">if</span> upload_url:</span><br><span class="line">            success = success + <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> upload_url</span><br><span class="line">        failure = failure + <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">"异常："</span>, e)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cached_img_url</span><span class="params">(img_loc_path)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    根据给定的本地图片绝对路径，转换成一个网上路径。</span></span><br><span class="line"><span class="string">    如果本地缓存中有，则直接读取并返回，如果没有，则上传后返回。</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    conn = sqlite3.connect(md_loc + <span class="string">'./img_hash_cache.db'</span>)</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cursor.execute(<span class="string">''' </span></span><br><span class="line"><span class="string">            CREATE TABLE if not exists img_cache_table (</span></span><br><span class="line"><span class="string">                img_hash TEXT,</span></span><br><span class="line"><span class="string">                real_p TEXT,</span></span><br><span class="line"><span class="string">                img_url TEXT</span></span><br><span class="line"><span class="string">            )</span></span><br><span class="line"><span class="string">            '''</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    img_hash = md5(open(img_loc_path, <span class="string">'rb'</span>).read()).hexdigest()  <span class="comment"># 图片的hash值，用来确定图片的唯一性，避免多次上传，浪费流量</span></span><br><span class="line">    cursor.execute(<span class="string">"SELECT img_url FROM img_cache_table WHERE img_hash='%s'"</span> % img_hash)  <span class="comment"># 根据图片的hash值来找缓存下来的图片网址</span></span><br><span class="line">    select_res = [row <span class="keyword">for</span> row <span class="keyword">in</span> cursor]</span><br><span class="line">    img_url = (</span><br><span class="line">        select_res[<span class="number">0</span>][<span class="number">0</span>] <span class="keyword">if</span> select_res <span class="keyword">and</span> len(select_res) &gt; <span class="number">0</span> <span class="keyword">and</span> select_res[<span class="number">0</span>] <span class="keyword">and</span> len(select_res[<span class="number">0</span>]) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="keyword">None</span>)</span><br><span class="line"></span><br><span class="line">    remote_exists = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">if</span> img_url:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            remote_exists = urllib.request.urlopen(img_url).code == <span class="number">200</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">'#warning: 网址不存在 ：'</span>, img_url)</span><br><span class="line">            cursor.execute(<span class="string">"DELETE FROM img_cache_table WHERE img_hash='%s'"</span> % img_hash)</span><br><span class="line">            remote_exists = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">if</span> remote_exists:</span><br><span class="line">        print(<span class="string">"已缓存"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> img_url <span class="keyword">or</span> <span class="keyword">not</span> remote_exists:  <span class="comment"># 如果没有查到图片的网址，或者网址失效</span></span><br><span class="line">        print(<span class="string">'上传图片 ：'</span>, img_loc_path)</span><br><span class="line">        img_url = upload_file(img_loc_path)  <span class="comment"># 接取上传后的图片信息</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> img_url:  <span class="comment"># 如果图片地址为空，则说明上传失败</span></span><br><span class="line">            print(<span class="string">'#warning: 上传失败'</span>)</span><br><span class="line">            conn.close()</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> remote_exists:</span><br><span class="line">                cursor.execute(<span class="string">'INSERT INTO img_cache_table VALUES(?,?,?)'</span>,</span><br><span class="line">                               (img_hash, img_loc_path, img_url))  <span class="comment"># 如果上传成功，则直接缓存下来</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                cursor.execute(<span class="string">"UPDATE img_cache_table SET img_url='%s', u_info='%s' WHERE img_hash='%s'"</span> % (</span><br><span class="line">                img_url, img_hash))</span><br><span class="line">            conn.commit()</span><br><span class="line">    conn.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img_url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zip_pic</span><span class="params">(loc_p)</span>:</span></span><br><span class="line">    o_img = loc_p + <span class="string">'.ori'</span>  <span class="comment"># 原始未压缩的图片</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(o_img) <span class="keyword">or</span> <span class="keyword">not</span> imghdr.what(o_img):  <span class="comment"># 如果没有的话，那就需要进行压缩处理</span></span><br><span class="line">            print(<span class="string">'压缩图片 ：'</span>, loc_p)</span><br><span class="line">            s_img = tinify.from_file(loc_p)</span><br><span class="line">            s_img.to_file(loc_p + <span class="string">'.z'</span>)</span><br><span class="line">            os.rename(loc_p, loc_p + <span class="string">'.ori'</span>)</span><br><span class="line">            os.rename(loc_p + <span class="string">'.z'</span>, loc_p)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">'#warning: tinypng压缩出问题了，图片未压缩。'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_pic_proc</span><span class="params">(md_file, match)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> re.match(<span class="string">'((http(s?))|(ftp))://.*'</span>, match):  <span class="comment"># 判断是不是已经是一个图片的网址</span></span><br><span class="line">        loc_p = match</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(loc_p) <span class="keyword">or</span> <span class="keyword">not</span> os.path.isfile(loc_p):</span><br><span class="line">            <span class="comment"># 如果文件不存在，则可能这是用的一个相对路径，需要转成绝对路径</span></span><br><span class="line">            <span class="comment"># Windows中 md_file的本地路径为反斜杠\\, match的相对路径为 "MD标题\图片文件名"</span></span><br><span class="line">            loc_p = (md_file[:md_file.rfind(<span class="string">'\\'</span>) + <span class="number">1</span>] + match) <span class="keyword">if</span> os_name == <span class="string">'Windows'</span> <span class="keyword">else</span> (</span><br><span class="line">                        md_file[:md_file.rfind(<span class="string">'/'</span>) + <span class="number">1</span>] + match)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(loc_p) <span class="keyword">and</span> os.path.isfile(loc_p) <span class="keyword">and</span> imghdr.what(loc_p):</span><br><span class="line">            <span class="keyword">if</span> need_zip:</span><br><span class="line">                zip_pic(loc_p)</span><br><span class="line">            <span class="keyword">if</span> need_cache:</span><br><span class="line">                file_url = cached_img_url(loc_p)  <span class="comment"># 获取上传后的图片地址</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">'上传图片 ：'</span>, loc_p)</span><br><span class="line">                file_url = upload_file(loc_p)</span><br><span class="line">                <span class="keyword">if</span> file_url <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">                    print(<span class="string">"上传失败"</span>)</span><br><span class="line">            <span class="keyword">return</span> file_url</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">'#warning: 文件不存在或者不是图片文件 ：'</span>, loc_p)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'markdown文件中的图片用的是网址 ：'</span>, match)</span><br><span class="line">        file_url = transfer_online_img(match)  <span class="comment"># 获取上传后的图片地址</span></span><br><span class="line">        <span class="keyword">return</span> file_url</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md_img_find</span><span class="params">(md_file)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    将给定的markdown文件里的图片本地路径转换成网上路径</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">if</span> need_back:</span><br><span class="line">        bak_md = <span class="string">'%s.bak'</span> % md_file</span><br><span class="line">        shutil.copyfile(md_file, bak_md)  <span class="comment"># 在执行改动之前备份原MD文件，可手动删除</span></span><br><span class="line">        print(<span class="string">'origin markdown file backup in: %s'</span> % bak_md)</span><br><span class="line">    post = <span class="keyword">None</span>  <span class="comment"># 用来存放markdown文件内容</span></span><br><span class="line">    <span class="keyword">global</span> total, success, failure, ignore</span><br><span class="line">    <span class="keyword">with</span> open(md_file, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:  <span class="comment"># 使用utf-8 编码打开 by chalkit</span></span><br><span class="line">        post = f.read()</span><br><span class="line">        matches = re.compile(<span class="string">'!\\[.*?\\]\\((.*?)\\)|&lt;img.*?src=[\'\"](.*?)[\'\"].*?&gt;'</span>).findall(post)  <span class="comment"># 匹配md文件中的图片</span></span><br><span class="line">        <span class="keyword">if</span> matches <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> len(matches) == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">"%s no matches"</span> % md_file)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">for</span> sub_match <span class="keyword">in</span> matches:  <span class="comment"># 正则里有个或，所以有分组，需要单独遍历去修改</span></span><br><span class="line">            <span class="keyword">for</span> match <span class="keyword">in</span> sub_match:  <span class="comment"># 遍历去修改每个图片</span></span><br><span class="line">                <span class="keyword">if</span> match <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> len(match) == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                total = total + <span class="number">1</span></span><br><span class="line">                print(<span class="string">"match pic : "</span>, match)</span><br><span class="line">                file_url = upload_pic_proc(md_file, match)</span><br><span class="line">                <span class="keyword">if</span> file_url:</span><br><span class="line">                    post = post.replace(match, file_url)  <span class="comment"># 替换md文件中的地址</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    ignore += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            open(md_file, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>).write(post)  <span class="comment"># 如果有内容的话，就直接覆盖写入当前的markdown文件</span></span><br><span class="line">            <span class="comment"># 仍然注意用uft-8编码打开</span></span><br><span class="line">    print(<span class="string">'Complete!'</span>)</span><br><span class="line">    print(<span class="string">' total   :%d'</span> % total)</span><br><span class="line">    print(<span class="string">' success :%d'</span> % success)</span><br><span class="line">    print(<span class="string">' failure :%d'</span> % failure)</span><br><span class="line">    print(<span class="string">' ignore  :%d'</span> % ignore)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_md</span><span class="params">(folder)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    在给定的目录下寻找md文件</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">if</span> len(folder) &gt; <span class="number">3</span> <span class="keyword">and</span> folder[folder.rfind(<span class="string">'.'</span>) + <span class="number">1</span>:] == <span class="string">'md'</span>:</span><br><span class="line">        md_img_find(folder)  <span class="comment"># 判断是否是一个md文件，如果是的话，直接开始转换</span></span><br><span class="line">    <span class="keyword">elif</span> os.path.isdir(folder):</span><br><span class="line">        files = os.listdir(folder)</span><br><span class="line">        <span class="comment"># 读取目录下的文件</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            curp = folder + <span class="string">'/'</span> + file</span><br><span class="line">            <span class="keyword">if</span> os.path.isdir(curp):</span><br><span class="line">                find_md(curp)  <span class="comment"># 递归读取</span></span><br><span class="line">            <span class="keyword">elif</span> file[file.rfind(<span class="string">'.'</span>) + <span class="number">1</span>:] == <span class="string">'md'</span>:</span><br><span class="line">                md_img_find(curp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_config</span><span class="params">(cfg_file_path)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> cloud_cfg</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(cfg_file_path) <span class="keyword">and</span> os.path.isfile(cfg_file_path):</span><br><span class="line">        config = configparser.ConfigParser()</span><br><span class="line">        config.read(cfg_file_path, encoding=<span class="string">"utf-8"</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            option = config.get(<span class="string">'common'</span>, <span class="string">'option'</span>)</span><br><span class="line">            <span class="keyword">if</span> option == <span class="string">"upai"</span>:</span><br><span class="line">                servicename = config.get(option, <span class="string">"servicename"</span>)</span><br><span class="line">                operatorname = config.get(option, <span class="string">"operatorname"</span>)</span><br><span class="line">                password = config.get(option, <span class="string">"password"</span>)</span><br><span class="line">                domain = config.get(option, <span class="string">"domain"</span>)</span><br><span class="line">                cloud_cfg = Upai(servicename, operatorname, password, domain)</span><br><span class="line">            <span class="keyword">elif</span> option == <span class="string">"qiniu"</span>:</span><br><span class="line">                ak = config.get(option, <span class="string">"accesskey"</span>)</span><br><span class="line">                sk = config.get(option, <span class="string">"secretkey"</span>)</span><br><span class="line">                bucketname = config.get(option, <span class="string">"bucketname"</span>)</span><br><span class="line">                domain = config.get(option, <span class="string">"domain"</span>)</span><br><span class="line">                cloud_cfg = Qiniu(ak, sk, bucketname, domain)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">"目前不支持除又拍、七牛以外的云存储服务"</span>)</span><br><span class="line">                sys.exit(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> need_zip:</span><br><span class="line">                tinify.key = config.get(<span class="string">'common'</span>, <span class="string">'tinypngkey'</span>)  <span class="comment"># 设置tinipng的key</span></span><br><span class="line">        <span class="keyword">except</span> configparser.NoOptionError <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">"配置出错: "</span>, e)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"配置文件路径出错"</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">usage</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'''</span></span><br><span class="line"><span class="string">usage: </span></span><br><span class="line"><span class="string">    python %s file [-c|--config configfile] [-z|--zip] [--cache] [-b|--back]</span></span><br><span class="line"><span class="string">    python %s -R|--Recursive directory [-c|--config configfile] [-z|--zip] [-b|--back]</span></span><br><span class="line"><span class="string">    python %s -h|--help</span></span><br><span class="line"><span class="string">    '''</span> % (sys.argv[<span class="number">0</span>], sys.argv[<span class="number">0</span>], sys.argv[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    dir_path = <span class="string">''</span></span><br><span class="line">    file_path = <span class="string">''</span></span><br><span class="line">    config_file = <span class="string">''</span></span><br><span class="line">    os_name = platform.system()</span><br><span class="line">    find_err = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        opts, args = getopt.getopt(sys.argv[<span class="number">1</span>:], <span class="string">'hR:c:zb'</span>, [<span class="string">"help"</span>, <span class="string">"Recursive="</span>, <span class="string">"config="</span>, <span class="string">"zip"</span>, <span class="string">"cache"</span>, <span class="string">"back"</span>])</span><br><span class="line">        <span class="keyword">for</span> opt, arg <span class="keyword">in</span> opts:</span><br><span class="line">            <span class="keyword">if</span> opt <span class="keyword">in</span> (<span class="string">"-h"</span>, <span class="string">"--help"</span>):</span><br><span class="line">                usage()</span><br><span class="line">                sys.exit(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">elif</span> opt <span class="keyword">in</span> (<span class="string">"-R"</span>, <span class="string">"--Recursive"</span>):</span><br><span class="line">                dir_path = arg</span><br><span class="line">            <span class="keyword">elif</span> opt <span class="keyword">in</span> (<span class="string">"-c"</span>, <span class="string">"--config"</span>):</span><br><span class="line">                config_file = arg</span><br><span class="line">            <span class="keyword">elif</span> opt <span class="keyword">in</span> (<span class="string">"-z"</span>, <span class="string">"--zip"</span>):</span><br><span class="line">                need_zip = <span class="keyword">True</span></span><br><span class="line">            <span class="keyword">elif</span> opt == <span class="string">"--cache"</span>:</span><br><span class="line">                need_cache = <span class="keyword">True</span></span><br><span class="line">            <span class="keyword">elif</span> opt <span class="keyword">in</span> (<span class="string">"-b"</span>, <span class="string">"--back"</span>):</span><br><span class="line">                need_back = <span class="keyword">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                usage()</span><br><span class="line">                exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> args <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> (len(args) != <span class="number">0</span>):</span><br><span class="line">            <span class="keyword">if</span> len(args) == <span class="number">1</span>:</span><br><span class="line">                file_path = args[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                find_err = <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">except</span> getopt.GetoptError:</span><br><span class="line">        usage()</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> (file_path <span class="keyword">and</span> dir_path) <span class="keyword">or</span> (<span class="keyword">not</span> file_path <span class="keyword">and</span> <span class="keyword">not</span> dir_path) <span class="keyword">or</span> find_err:</span><br><span class="line">        <span class="comment"># 两个都设置或者两个都没设置或者已经发现错误，出错</span></span><br><span class="line">        usage()</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> file_path:</span><br><span class="line">        c_p = file_path</span><br><span class="line">        md_loc = c_p[:c_p.rfind(<span class="string">'/'</span>) + <span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        c_p = dir_path</span><br><span class="line">        <span class="keyword">if</span> c_p[<span class="number">-1</span>] == <span class="string">'/'</span>:</span><br><span class="line">            md_loc = c_p</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            md_loc = c_p + <span class="string">'/'</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> config_file:</span><br><span class="line">        <span class="keyword">if</span> os_name == <span class="string">'Windows'</span>:</span><br><span class="line">            print(<span class="string">"please input config file path in Windows"</span>)</span><br><span class="line">            exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            config_file = os.getenv(<span class="string">"HOME"</span>) + <span class="string">"/.mdPicTransfer.cfg"</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(c_p):</span><br><span class="line">        print(<span class="string">"路径不存在"</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    get_config(config_file)</span><br><span class="line">    find_md(c_p)</span><br></pre></td></tr></table></figure>
<p>   <strong>CommonYun.py</strong>, 云存储基类</p>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> abstractmethod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommonYun</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, domain)</span>:</span></span><br><span class="line">        self.domain = domain</span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">(self)</span>:</span> <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>   <strong>UpYun.py</strong>, 又拍云类</p>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> upyun</span><br><span class="line"><span class="keyword">from</span> CommonYun <span class="keyword">import</span> CommonYun</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Upai</span><span class="params">(CommonYun)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, servicename, operatorname, password, domain)</span>:</span></span><br><span class="line">        self.option = <span class="string">"upai"</span></span><br><span class="line">        CommonYun.__init__(self, domain)</span><br><span class="line">        self.up = upyun.UpYun(servicename, operatorname, password)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">(self, upload_file_name, key, is_old_link)</span>:</span></span><br><span class="line">        res = <span class="keyword">None</span></span><br><span class="line">        <span class="keyword">if</span> is_old_link:</span><br><span class="line">            response = requests.get(upload_file_name)</span><br><span class="line">            <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">                file = BytesIO(response.content)</span><br><span class="line">                res = self.up.put(key, file, checksum=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">with</span> open(upload_file_name, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                res = self.up.put(key, f, checksum=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self.domain + <span class="string">"/"</span> + key <span class="keyword">if</span> res <span class="keyword">else</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<p>   <strong>QiniuYun.py</strong>, 七牛云类</p>
   <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qiniu <span class="keyword">import</span> Auth, put_file, etag, BucketManager</span><br><span class="line"><span class="keyword">from</span> CommonYun <span class="keyword">import</span> CommonYun</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Qiniu</span><span class="params">(CommonYun)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, accesskey, secretkey, bucketname, domain)</span>:</span></span><br><span class="line">        self.option = <span class="string">"qiniu"</span></span><br><span class="line">        self.bucketname = bucketname</span><br><span class="line">        CommonYun.__init__(self, domain)</span><br><span class="line">        self.qiniu = Auth(accesskey, secretkey)  <span class="comment"># 七牛认证</span></span><br><span class="line">        self.Bucket_Manager = BucketManager(self.qiniu)  <span class="comment"># 初始化BucketManager</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">(self, upload_file_name, key, is_old_link)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> is_old_link:</span><br><span class="line">            ret, info = self.Bucket_Manager.fetch(upload_file_name, self.bucketname, key)</span><br><span class="line">            <span class="keyword">if</span> ret[<span class="string">'key'</span>] == key:</span><br><span class="line">                <span class="keyword">return</span> self.domain + <span class="string">'/'</span> + key</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mime_type = upload_file_name[upload_file_name.rfind(<span class="string">'.'</span>) + <span class="number">1</span>:]</span><br><span class="line">            token = self.qiniu.upload_token(self.bucketname, key)</span><br><span class="line">            ret, info = put_file(token, key, upload_file_name, mime_type=mime_type, check_crc=<span class="keyword">True</span>)</span><br><span class="line">            <span class="keyword">if</span> ret[<span class="string">'key'</span>] == key <span class="keyword">and</span> ret[<span class="string">'hash'</span>] == etag(upload_file_name):</span><br><span class="line">                <span class="keyword">return</span> self.domain + <span class="string">'/'</span> + key</span><br></pre></td></tr></table></figure>
<h2 id="演示效果"><a href="#演示效果" class="headerlink" title="演示效果"></a>演示效果</h2><p>   运行该程序，将得到文件与备份文件用<code>git diff origin cur</code>,比较有如下结果：</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">diff --git &quot;a/Java\345\271\266\345\217\221.md&quot; &quot;b/Java\345\271\266\345\217\221.md.bak&quot;</span><br><span class="line">index 2ba4604..5db5bf0 100644</span><br><span class="line">--- &quot;a/Java\345\271\266\345\217\221.md&quot;</span><br><span class="line">+++ &quot;b/Java\345\271\266\345\217\221.md.bak&quot;</span><br><span class="line">@@ -2,7 +2,7 @@</span><br><span class="line"> </span><br><span class="line"> ### 一、线程状态转换</span><br><span class="line"> </span><br><span class="line">-&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;http://hjx-markdown-images.test.upcdn.net/20190906_--cache/image1.png&quot; width=&quot;600px&quot;&gt; &lt;/div&gt;&lt;br&gt;</span><br><span class="line">+&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;pics/adfb427d-3b21-40d7-a142-757f4ed73079.png&quot; width=&quot;600px&quot;&gt; &lt;/div&gt;&lt;br&gt;</span><br><span class="line"> </span><br><span class="line"> #### 新建（New）</span><br><span class="line"> </span><br><span class="line">@@ -675,7 +675,7 @@ java.util.concurrent（J.U.C）大大提高了并发性能，AQS 被认为是 J.</span><br><span class="line"> </span><br><span class="line"> 维护了一个计数器 cnt，每次调用 countDown() 方法会让计数器的值减 1，减到 0 的时候，那些因为调用 await() 方法而在等待的线程就会被唤醒。</span><br><span class="line"> </span><br><span class="line">-&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;http://hjx-markdown-images.test.upcdn.net/20190906_--cache/image2.png&quot; width=&quot;300px&quot;&gt; &lt;/div&gt;&lt;br&gt;</span><br><span class="line">+&lt;div align=&quot;center&quot;&gt; &lt;img src=&quot;pics/ba078291-791e-4378-b6d1-ece76c2f0b14.png&quot; width=&quot;300px&quot;&gt; &lt;/div&gt;&lt;br&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="hjx051013.github.io/2019/07/14/电梯运行模拟/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jiaxinhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追风少年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/14/电梯运行模拟/" itemprop="url">电梯运行模拟</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-14T13:51:32+08:00">
                2019-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/短发/" itemprop="url" rel="index">
                    <span itemprop="name">短发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/07/14/电梯运行模拟/" class="leancloud_visitors" data-flag-title="电梯运行模拟">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
                <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  9
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>​    日常生活中，大家都坐过电梯，有时候会想想电梯在每个人按下键之后是怎么运行的呢？这是个看起来似乎简单但想清楚却也不容易的问题。</p>
<p>​    给电梯的运行进行建模。电梯在运行过程中会载人同时接受外部的请求，这样我们可以用两个队列来表示载人信息和请求信息。对于乘客来说，其信息主要是当前楼层和目标楼层，为了方便打印，给每个乘客命名。电梯的运行有三种状态：WAIT(停)，UP(上)，DOWN(下)。电梯根据载人队列和请求队列来更新自己的状态，在每一层都判断是否可以进人(针对请求队列)，出人(针对载人队列)。下面是运行算法图示。</p>
<p><img src="http://ww2.sinaimg.cn/large/006tNc79ly1g4zcucdqylj30jb0f3q3z.jpg" alt="image-20190714143300244"></p>
<p>​    当电梯处于上行/下行状态时，到达新的楼层时(本次循环开始)，每次循环检查是否需要有人进出，根据载人列表、请求列表及当前运行状态判断出接下来的状态，如果是上行/下行，沉睡1s作为上行/下行一层楼的时间。算法的特征是，先来先服务，在上行/下行过程中尽可能接到或者放出更多的人，在上行/下行过程中只接受与电梯运行方向一致的人。</p>
<p>​    代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">从文件中读入输入命令及参数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Elevator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;EleInfo&gt; infoList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        start();</span><br><span class="line">        <span class="keyword">new</span> EleRunner(infoList).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> minFloor = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> maxFloor = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> inputValid = <span class="keyword">false</span>;</span><br><span class="line">        Scanner in = <span class="keyword">new</span> Scanner(</span><br><span class="line">                <span class="keyword">new</span> FileInputStream(<span class="string">"/Users/macbook/programming/Java/leetcode/src/com/test/input.txt"</span>),<span class="string">"UTF-8"</span>);</span><br><span class="line">        PrintWriter out = <span class="keyword">new</span> PrintWriter(</span><br><span class="line">                <span class="keyword">new</span> FileOutputStream(<span class="string">"/Users/macbook/programming/Java/leetcode/src/com/test/log.txt"</span>,<span class="keyword">true</span>),<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">while</span>(!inputValid) &#123;</span><br><span class="line">            out.println(<span class="string">"电梯模拟运行开始,请输入参数（最低楼层，最高楼层）:"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                minFloor = Integer.parseInt(in.next());</span><br><span class="line">                maxFloor = Integer.parseInt(in.next());</span><br><span class="line">                inputValid = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                System.out.println(<span class="string">"输入异常！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            out.println(<span class="string">"请输入命令(up/down/stop/start):"</span>);</span><br><span class="line">            String cmd = in.next();</span><br><span class="line">            <span class="keyword">if</span>(started &amp;&amp; cmd.equals(<span class="string">"start"</span>)) &#123;</span><br><span class="line">                <span class="comment">//已经开始但输入命令仍是start, 报错</span></span><br><span class="line">                System.out.println(<span class="string">"已经开始，不能再输入start!"</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!started &amp;&amp; !cmd.equals(<span class="string">"start"</span>)) &#123;</span><br><span class="line">                <span class="comment">//没有开始但是输入命令不是start,报错</span></span><br><span class="line">                out.println(<span class="string">"请输入start开始！"</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cmd.equals(<span class="string">"start"</span>)) &#123;<span class="comment">//开始</span></span><br><span class="line">                started = <span class="keyword">true</span>;</span><br><span class="line">                infoList.add(<span class="keyword">new</span> EleInfo(<span class="keyword">null</span>, minFloor, maxFloor, <span class="string">"start"</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cmd.equals(<span class="string">"stop"</span>)) &#123;<span class="comment">//结束，跳出循环</span></span><br><span class="line">                infoList.add(<span class="keyword">new</span> EleInfo(<span class="keyword">null</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">"stop"</span>));</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(cmd.equals(<span class="string">"up"</span>) || cmd.equals(<span class="string">"down"</span>)) &#123;</span><br><span class="line">                String name = in.next();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span> curFloor = Integer.parseInt(in.next());</span><br><span class="line">                    <span class="keyword">int</span> targetFloor = Integer.parseInt(in.next());</span><br><span class="line">                    <span class="keyword">if</span> (curFloor&gt;=minFloor&amp;&amp;curFloor&lt;=maxFloor&amp;&amp;targetFloor&gt;=minFloor</span><br><span class="line">                            &amp;&amp;targetFloor&lt;=maxFloor&amp;&amp;targetFloor!=curFloor) &#123;</span><br><span class="line">                        <span class="keyword">if</span>((cmd.equals(<span class="string">"up"</span>)&amp;&amp;curFloor&gt;=targetFloor) || (cmd.equals(<span class="string">"down"</span>)&amp;&amp;curFloor&lt;=targetFloor)) &#123;</span><br><span class="line">                            out.println(<span class="string">"命令与输入楼层不匹配"</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(curFloor==targetFloor) &#123;</span><br><span class="line">                            out.println(<span class="string">"目标楼层与当前楼层不一致！"</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!isNameDuplicated(name)) &#123;</span><br><span class="line">                          	out.println(<span class="string">"人名重复！"</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;<span class="comment">//一切输入合法</span></span><br><span class="line">                            infoList.add(<span class="keyword">new</span> EleInfo(name, curFloor, targetFloor, cmd));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span>(curFloor &lt; minFloor || curFloor &gt; maxFloor) &#123;</span><br><span class="line">                            out.println(<span class="string">"当前楼层不合法！"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span>(targetFloor &lt; minFloor || targetFloor &gt; maxFloor) &#123;</span><br><span class="line">                            out.println(<span class="string">"目标楼层不合法！"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span>(targetFloor==curFloor) &#123;</span><br><span class="line">                            out.println(<span class="string">"当前楼层与目标楼层不能相同！"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    out.println(<span class="string">"输入楼层异常！"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                out.println(<span class="string">"输入命令出错！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNameDuplicated</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(EleInfo e:infoList) &#123;</span><br><span class="line">      <span class="keyword">if</span>(e.name.equals(name)) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EleInfo</span> </span>&#123;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">int</span> curFloor;</span><br><span class="line">    <span class="keyword">int</span> targetFloor;</span><br><span class="line">    String cmd;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EleInfo</span><span class="params">(String name, <span class="keyword">int</span> curFloor, <span class="keyword">int</span> targetFloor, String cmd)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.curFloor = curFloor;</span><br><span class="line">        <span class="keyword">this</span>.targetFloor = targetFloor;</span><br><span class="line">        <span class="keyword">this</span>.cmd = cmd;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">电梯运行过程状态变化</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EleRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;EleInfo&gt; requestList;</span><br><span class="line">    <span class="keyword">private</span> List&lt;EleInfo&gt; inElevatorList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    PrintWriter out;</span><br><span class="line">    <span class="keyword">private</span> ElevatorState state = ElevatorState.WAIT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> curFloor = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EleRunner</span><span class="params">(List&lt;EleInfo&gt; infoList)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.requestList = infoList;</span><br><span class="line">        out = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> FileOutputStream(<span class="string">"/Users/macbook/programming/Java/leetcode/src/com/test/output.txt"</span>,<span class="keyword">true</span>),<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(requestList.isEmpty()) <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">while</span>(started) &#123;</span><br><span class="line">                <span class="keyword">if</span>(requestList.isEmpty()) &#123;</span><br><span class="line">                    state = ElevatorState.WAIT;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(requestList.size()==<span class="number">1</span> &amp;&amp; inElevatorList.isEmpty() &amp;&amp; requestList.get(<span class="number">0</span>).cmd.equals(<span class="string">"stop"</span>)) &#123;</span><br><span class="line">                    out.println(<span class="string">"电梯停止运行！"</span>);</span><br><span class="line">                    requestList.remove(<span class="number">0</span>);</span><br><span class="line">                    started = <span class="keyword">false</span>;</span><br><span class="line">                    stop = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">switch</span>(state) &#123;</span><br><span class="line">                    <span class="keyword">case</span> WAIT:</span><br><span class="line">                        waitProc();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> UP:</span><br><span class="line">                        upProc();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> DOWN:</span><br><span class="line">                        downProc();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(!requestList.isEmpty()) personIn();<span class="comment">//状态更新，可能还可以有人进来</span></span><br><span class="line">                <span class="keyword">if</span>(state==ElevatorState.UP || state==ElevatorState.DOWN) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    curFloor = (state==ElevatorState.UP)?(curFloor+<span class="number">1</span>):(curFloor-<span class="number">1</span>);</span><br><span class="line">                    String stateStr = (state==ElevatorState.UP)?<span class="string">"上升"</span>:<span class="string">"下降"</span>;</span><br><span class="line">                    out.println(<span class="string">"电梯到达"</span>+curFloor+<span class="string">"楼，处于"</span>+stateStr);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(stop) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span>(requestList.get(<span class="number">0</span>).cmd.equals(<span class="string">"start"</span>)) &#123;</span><br><span class="line">                started = <span class="keyword">true</span>;</span><br><span class="line">                curFloor = requestList.get(<span class="number">0</span>).curFloor;</span><br><span class="line">                out.println(<span class="string">"电梯启动！"</span>);</span><br><span class="line">                requestList.remove(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">waitProc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(requestList.isEmpty()&amp;&amp;inElevatorList.isEmpty()) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//没有请求但是电梯还载着人</span></span><br><span class="line">            <span class="keyword">if</span>(!requestList.isEmpty()) personIn();</span><br><span class="line">            <span class="keyword">if</span>(!inElevatorList.isEmpty()) personOut();</span><br><span class="line">            <span class="keyword">if</span>(!inElevatorList.isEmpty()) &#123;</span><br><span class="line">                state = inElevatorList.get(<span class="number">0</span>).targetFloor &gt; curFloor ? state = ElevatorState.UP:ElevatorState.DOWN;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(isOnlyStopReq())&#123;</span><br><span class="line">                state = ElevatorState.WAIT;</span><br><span class="line">                out.println(<span class="string">"电梯处于等待状态"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!requestList.isEmpty())&#123;</span><br><span class="line">                <span class="keyword">if</span>(!requestList.get(<span class="number">0</span>).cmd.equals(<span class="string">"stop"</span>))</span><br><span class="line">                    state = requestList.get(<span class="number">0</span>).curFloor &gt; curFloor ? state = ElevatorState.UP:ElevatorState.DOWN;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">upProc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(requestList.isEmpty()&amp;&amp;inElevatorList.isEmpty()) &#123;</span><br><span class="line">            state = ElevatorState.WAIT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(!requestList.isEmpty()) personIn();<span class="comment">//请求队列不空，看是否可以进人</span></span><br><span class="line">            <span class="keyword">if</span>(!inElevatorList.isEmpty()) personOut();<span class="comment">//在电梯队列不空，看是否可以放人</span></span><br><span class="line">            <span class="keyword">if</span>(!inElevatorList.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">for</span>(EleInfo e:inElevatorList) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(e.targetFloor &gt; curFloor) <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                state = ElevatorState.DOWN;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(isOnlyStopReq())&#123;</span><br><span class="line">                state = ElevatorState.WAIT;</span><br><span class="line">                out.println(<span class="string">"电梯处于等待状态"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!requestList.isEmpty())&#123;</span><br><span class="line">                <span class="keyword">for</span>(EleInfo e:requestList) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(!e.cmd.equals(<span class="string">"stop"</span>)&amp;&amp;e.curFloor &gt; curFloor) <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                state = ElevatorState.DOWN;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">downProc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(requestList.isEmpty()&amp;&amp;inElevatorList.isEmpty()) &#123;</span><br><span class="line">            state = ElevatorState.WAIT;</span><br><span class="line">            out.println(<span class="string">"电梯处于等待状态"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(!requestList.isEmpty()) personIn();</span><br><span class="line">            <span class="keyword">if</span>(!inElevatorList.isEmpty()) personOut();</span><br><span class="line">            <span class="keyword">if</span>(!inElevatorList.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">for</span>(EleInfo e:inElevatorList) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(e.targetFloor &lt; curFloor) <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                state = ElevatorState.UP;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(isOnlyStopReq())&#123;</span><br><span class="line">                state = ElevatorState.WAIT;</span><br><span class="line">                out.println(<span class="string">"电梯处于等待状态"</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(!requestList.isEmpty())&#123;</span><br><span class="line">                <span class="keyword">for</span>(EleInfo e:requestList) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(!e.cmd.equals(<span class="string">"stop"</span>)&amp;&amp;e.curFloor &lt; curFloor) <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                state = ElevatorState.UP;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">personIn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator&lt;EleInfo&gt; iterator = requestList.iterator();</span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext()) &#123;<span class="comment">//将curFloor等于电梯curFloor的请求删除，并放入inElevatorList中</span></span><br><span class="line">            EleInfo e = iterator.next();</span><br><span class="line">            <span class="keyword">if</span>(e.curFloor==curFloor&amp;&amp;(state==ElevatorState.UP?(e.cmd.equals(<span class="string">"up"</span>)):e.cmd.equals(<span class="string">"down"</span>))) &#123;</span><br><span class="line">                out.println(e.name+<span class="string">"在"</span>+curFloor+<span class="string">"楼进电梯了!"</span>);</span><br><span class="line">                iterator.remove();</span><br><span class="line">                inElevatorList.add(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">personOut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator&lt;EleInfo&gt; iterator = inElevatorList.iterator();</span><br><span class="line">        <span class="keyword">while</span>(iterator.hasNext()) &#123;<span class="comment">//首先把在电梯上目标楼层是当前楼层的人放出</span></span><br><span class="line">            EleInfo e = iterator.next();</span><br><span class="line">            <span class="keyword">if</span>(e.targetFloor == curFloor) &#123;</span><br><span class="line">                out.println(e.name+<span class="string">"在"</span>+curFloor+<span class="string">"楼出电梯了!"</span>);</span><br><span class="line">                iterator.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isOnlyStopReq</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> requestList.size()==<span class="number">1</span>&amp;&amp;requestList.get(<span class="number">0</span>).cmd.equals(<span class="string">"stop"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> ElevatorState &#123;</span><br><span class="line">    WAIT,</span><br><span class="line">    UP,</span><br><span class="line">    DOWN</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输入示例：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1 20</span><br><span class="line">start</span><br><span class="line">up</span><br><span class="line">hjx 2 10</span><br><span class="line">down</span><br><span class="line">hyk 6 2</span><br><span class="line">up</span><br><span class="line">hyk1 1 8</span><br><span class="line">down</span><br><span class="line">hjx2 15 2</span><br><span class="line">stop</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">电梯启动！</span><br><span class="line">hyk1在1楼进电梯了!</span><br><span class="line">电梯到达2楼，处于上升</span><br><span class="line">hjx在2楼进电梯了!</span><br><span class="line">电梯到达3楼，处于上升</span><br><span class="line">电梯到达4楼，处于上升</span><br><span class="line">电梯到达5楼，处于上升</span><br><span class="line">电梯到达6楼，处于上升</span><br><span class="line">电梯到达7楼，处于上升</span><br><span class="line">电梯到达8楼，处于上升</span><br><span class="line">hyk1在8楼出电梯了!</span><br><span class="line">电梯到达9楼，处于上升</span><br><span class="line">电梯到达10楼，处于上升</span><br><span class="line">hjx在10楼出电梯了!</span><br><span class="line">电梯到达11楼，处于上升</span><br><span class="line">电梯到达12楼，处于上升</span><br><span class="line">电梯到达13楼，处于上升</span><br><span class="line">电梯到达14楼，处于上升</span><br><span class="line">电梯到达15楼，处于上升</span><br><span class="line">hjx2在15楼进电梯了!</span><br><span class="line">电梯到达14楼，处于下降</span><br><span class="line">电梯到达13楼，处于下降</span><br><span class="line">电梯到达12楼，处于下降</span><br><span class="line">电梯到达11楼，处于下降</span><br><span class="line">电梯到达10楼，处于下降</span><br><span class="line">电梯到达9楼，处于下降</span><br><span class="line">电梯到达8楼，处于下降</span><br><span class="line">电梯到达7楼，处于下降</span><br><span class="line">电梯到达6楼，处于下降</span><br><span class="line">hyk在6楼进电梯了!</span><br><span class="line">电梯到达5楼，处于下降</span><br><span class="line">电梯到达4楼，处于下降</span><br><span class="line">电梯到达3楼，处于下降</span><br><span class="line">电梯到达2楼，处于下降</span><br><span class="line">hjx2在2楼出电梯了!</span><br><span class="line">hyk在2楼出电梯了!</span><br><span class="line">电梯处于等待状态</span><br><span class="line">电梯停止运行！</span><br></pre></td></tr></table></figure>
<p>可以观察一下输入的记录和电梯运行的结果，还是挺符合生活习惯的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="hjx051013.github.io/2019/07/05/进程间通信方式/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jiaxinhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追风少年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/05/进程间通信方式/" itemprop="url">进程间通信方式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-05T11:42:50+08:00">
                2019-07-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/07/05/进程间通信方式/" class="leancloud_visitors" data-flag-title="进程间通信方式">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
                <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  320
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Unix-IPC机制总结"><a href="#Unix-IPC机制总结" class="headerlink" title="Unix IPC机制总结"></a>Unix IPC机制总结</h1><p>进程间通信(IPC, InterProcess Communication)是指在不同进程间传播或者交换信息</p>
<p>常见IPC的方式有管道、消息队列、信号量、共享存储、socket、Streams等，其中socket和streams支持不同主机上的两个进程进行通信。</p>
<h2 id="一、管道"><a href="#一、管道" class="headerlink" title="一、管道"></a>一、管道</h2><h3 id="1-匿名管道"><a href="#1-匿名管道" class="headerlink" title="1. 匿名管道"></a>1. 匿名管道</h3><h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>半双工，即数据只能在一个方向上流动，读写端固定</li>
<li>只能在具有亲缘关系的进程之间通信</li>
<li>可以看成是特殊的文件，有文件描述符，但只存在于内存中</li>
</ul>
<h4 id="原型"><a href="#原型" class="headerlink" title="原型"></a>原型</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pipe</span><span class="params">(<span class="keyword">int</span> fd[<span class="number">2</span>])</span></span></span><br></pre></td></tr></table></figure>
<p><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g4otttvk0uj30l60kqgms.jpg" alt="image-20190705115418630"></p>
<p>要关闭管道只需要将这两个文件描述符关闭就行</p>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>通常调用pipe的进程接着fork，这样就创建了父、子进程之间的IPC通道</p>
<p><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g4ou19bfkjj316k0h642a.jpg" alt="image-20190705120627028"></p>
<p>若要数据流从父进程流向子进程，则需要关闭父进程的读端(fd[0])和子进程的写端(fd[1])；反之，则可以使得数据熊子进程流向父进程</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">pid_t</span> pid;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">20</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (pipe(fd) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"pipe error"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((pid = fork()) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    close(fd[<span class="number">0</span>]);</span><br><span class="line">    write(fd[<span class="number">1</span>], <span class="string">"hello world\n"</span>, <span class="built_in">strlen</span>(<span class="string">"hello world\n"</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="hjx051013.github.io/2019/05/29/Makefile赋值符辨析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jiaxinhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追风少年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/29/Makefile赋值符辨析/" itemprop="url">Makefile赋值符辨析.md</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-05-29T21:49:16+08:00">
                2019-05-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/C-C/" itemprop="url" rel="index">
                    <span itemprop="name">C/C++</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2019/05/29/Makefile赋值符辨析/" class="leancloud_visitors" data-flag-title="Makefile赋值符辨析.md">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
                <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  450
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  1
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Makefile-中-的区别"><a href="#Makefile-中-的区别" class="headerlink" title="Makefile 中:= ?= += =的区别"></a>Makefile 中:= ?= += =的区别</h2><p>在Makefile中我们经常看到 = := ?= +=这几个赋值运算符，那么他们有什么区别呢？我们来做个简单的实验</p>
<p>新建一个Makefile，内容为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ifdef DEFINE_VRE</span><br><span class="line">    VRE = “Hello World!”</span><br><span class="line">else</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">ifeq ($(OPT),define)</span><br><span class="line">    VRE ?= “Hello World! First!”</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">ifeq ($(OPT),add)</span><br><span class="line">    VRE += “Kelly!”</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">ifeq ($(OPT),recover)</span><br><span class="line">    VRE := “Hello World! Again!”</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">    @echo $(VRE)</span><br></pre></td></tr></table></figure></p>
<p>敲入以下make命令：</p>
<p>make DEFINE_VRE=true OPT=define 输出：Hello World!<br>make DEFINE_VRE=true OPT=add 输出：Hello World! Kelly!<br>make DEFINE_VRE=true OPT=recover  输出：Hello World! Again!<br>make DEFINE_VRE= OPT=define 输出：Hello World! First!<br>make DEFINE_VRE= OPT=add 输出：Kelly!<br>make DEFINE_VRE= OPT=recover 输出：Hello World! Again!</p>
<p>从上面的结果中我们可以清楚的看到他们的区别了</p>
<ul>
<li>= 是最基本的赋值</li>
<li>:= 是覆盖之前的值</li>
<li>?= 是如果没有被赋值过就赋予等号后面的值</li>
<li>+= 是添加等号后面的值</li>
</ul>
<p>之前一直纠结makefile中“=”和“:=”的区别到底有什么区别，因为给变量赋值时，两个符号都在使用。网上搜了一下，有人给出了解答，但是本人愚钝，看不懂什么意思。几寻无果之下，也就放下了。今天看一篇博客，无意中发现作者对于这个问题做了很好的解答。解决问题之余不免感叹，有时候给个例子不就清楚了吗？为什么非要说得那么学术呢。^_^</p>
<ol>
<li>“=”</li>
</ol>
<p>make会将整个makefile展开后，再决定变量的值。也就是说，变量的值将会是整个makefile中最后被指定的值。看例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x = foo</span><br><span class="line">y = $(x) bar</span><br><span class="line">x = xyz</span><br></pre></td></tr></table></figure></p>
<p>在上例中，y的值将会是 <code>xyz bar</code> ，而不是 <code>foo bar</code> 。</p>
<ol>
<li>“:=”</li>
</ol>
<p>“:=”表示变量的值决定于它在makefile中的位置，而不是整个makefile展开后的最终值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x := foo</span><br><span class="line">y := $(x) bar</span><br><span class="line">x := xyz</span><br></pre></td></tr></table></figure></p>
<p>在上例中，y的值将会是 <code>foo bar</code> ，而不是 <code>xyz bar</code>了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="hjx051013.github.io/2018/12/10/手写数字识别/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jiaxinhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追风少年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/10/手写数字识别/" itemprop="url">手写数字识别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-10T15:37:46+08:00">
                2018-12-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/机器学习/" itemprop="url" rel="index">
                    <span itemprop="name">机器学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/12/10/手写数字识别/" class="leancloud_visitors" data-flag-title="手写数字识别">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
                <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  13
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="逻辑回归与神经网络实现手写数字识别"><a href="#逻辑回归与神经网络实现手写数字识别" class="headerlink" title="逻辑回归与神经网络实现手写数字识别"></a>逻辑回归与神经网络实现手写数字识别</h1><p>本作业是采用Logistic回归和神经网络两种机器学习算法来识别0~9的手写数字。数据集来源于<a href="https://archive.ics.uci.edu/ml/machine-learning-databases/semeion/" target="_blank" rel="noopener">uci</a>,<br>编程语言为python,文档编写用jupyter notebook.通过wget命令下载数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!wget https://archive.ics.uci.edu/ml/machine-learning-databases/semeion/semeion.data</span><br></pre></td></tr></table></figure>
<h2 id="采用logistic算法识别手写数字"><a href="#采用logistic算法识别手写数字" class="headerlink" title="采用logistic算法识别手写数字"></a>采用logistic算法识别手写数字</h2><p>逻辑回归，是一种被广泛用于分类的算法，通过对线性回归外套一个sigmoid函数使之适用于分类情况。采用一对多策略，先训练出K个二分类器（K为分类总数），当输入新样本时，选择使假设函数值最大的那个分类器对应的分类。<br>首先导入机器学习常用的库，如numpy等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">%matplotlib inline</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> scipy.misc <span class="comment">#Used to show matrix as an image</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.cm <span class="keyword">as</span> cm <span class="comment">#Used to display images in a specific colormap</span></span><br></pre></td></tr></table></figure>
<h3 id="导入并处理数据"><a href="#导入并处理数据" class="headerlink" title="导入并处理数据"></a>导入并处理数据</h3><p>从文件导入数据，分析数据可知，数据共有1593行，每行有266个数字（0或1），其中前256个是16*16大小的手写数字图片的文本形式，后面10个数字分别表示0-9的识别结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fr = open(<span class="string">'semeion.data'</span>)</span><br><span class="line">data = fr.readlines()</span><br><span class="line">data = [line.strip().split() <span class="keyword">for</span> line <span class="keyword">in</span> data]</span><br><span class="line">print(<span class="string">"共有%d行数据,每行%d个数字"</span>%(len(data),len(data[<span class="number">0</span>])))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">共有1593行数据,每行266个数字</span><br></pre></td></tr></table></figure>
<p>将X,y从列表格式转成np.ndarray格式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(data)):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(data[<span class="number">0</span>])):</span><br><span class="line">        data[i][j] = int(float(data[i][j]))</span><br><span class="line">X = [example[<span class="number">0</span>:<span class="number">256</span>] <span class="keyword">for</span> example <span class="keyword">in</span> data]</span><br><span class="line">y_old = [example[<span class="number">256</span>:] <span class="keyword">for</span> example <span class="keyword">in</span> data]</span><br><span class="line">y = [line.index(<span class="number">1</span>) <span class="keyword">for</span> line <span class="keyword">in</span> y_old]</span><br><span class="line">X = np.array(X)</span><br><span class="line">y = np.array(y)</span><br></pre></td></tr></table></figure>
<h3 id="可视化数据"><a href="#可视化数据" class="headerlink" title="可视化数据"></a>可视化数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getDatumImg</span><span class="params">(row,width,height)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Function that is handed a single np array with shape 1x400,</span></span><br><span class="line"><span class="string">    crates an image object from it, and returns it</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    square = row[:].reshape(width,height)</span><br><span class="line">    <span class="keyword">return</span> square</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">displayData</span><span class="params">(width,height,indices_to_display = None)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Function that picks 100 random rows from X, creates a 20x20 image from each,</span></span><br><span class="line"><span class="string">    then stitches them together into a 10x10 grid of images, and shows it.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    nrows, ncols = <span class="number">10</span>, <span class="number">10</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> indices_to_display:</span><br><span class="line">        indices_to_display = random.sample(range(X.shape[<span class="number">0</span>]), nrows*ncols)</span><br><span class="line">        </span><br><span class="line">    big_picture = np.zeros((height*nrows,width*ncols))</span><br><span class="line">    </span><br><span class="line">    irow, icol = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> indices_to_display:</span><br><span class="line">        <span class="keyword">if</span> icol == ncols:</span><br><span class="line">            irow += <span class="number">1</span></span><br><span class="line">            icol  = <span class="number">0</span></span><br><span class="line">        iimg = getDatumImg(X[idx],width,height)</span><br><span class="line">        big_picture[irow*height:irow*height+iimg.shape[<span class="number">0</span>],icol*width:icol*width+iimg.shape[<span class="number">1</span>]] = iimg</span><br><span class="line">        icol += <span class="number">1</span></span><br><span class="line">    fig = plt.figure(figsize=(<span class="number">6</span>,<span class="number">6</span>))</span><br><span class="line">    img = scipy.misc.toimage( big_picture )</span><br><span class="line">    plt.imshow(img,cmap = cm.Greys_r)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">displayData(<span class="number">16</span>,<span class="number">16</span>,list(range(<span class="number">100</span>)))</span><br></pre></td></tr></table></figure>
<p><img src="http://hjx-markdown-images.test.upcdn.net/2018/12/10/56f276b5eb24e381b936b31b8c0dc51c.png" alt="handwriting digit recognition_12_1.png"></p>
<h3 id="训练算法：获得K-n-1-的参数矩阵"><a href="#训练算法：获得K-n-1-的参数矩阵" class="headerlink" title="训练算法：获得K*(n+1)的参数矩阵"></a>训练算法：获得K*(n+1)的参数矩阵</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加全为1的第一列</span></span><br><span class="line">X = np.insert(X,<span class="number">0</span>,values=np.ones(X.shape[<span class="number">0</span>]),axis=<span class="number">1</span>) <span class="comment"># m*(n+1)</span></span><br></pre></td></tr></table></figure>
<p>逻辑回归的代价函数如下图所示，其中第二项防止训练模型出现过拟合，也即经过正则化的代价函数<br><img src="http://hjx-markdown-images.test.upcdn.net/2018/12/10/ae8a18d497057eb07a446a0c5b5ae873.png" alt="Xnip2018-12-10_00-59-06.png"><br>逻辑回归代价函数对参数向量的梯度求解公式如下图所示，第二项也是为了防止过拟合的情况<br><img src="http://hjx-markdown-images.test.upcdn.net/2018/12/10/324b6dd047f5490f5e355d036982a764.png" alt="Xnip2018-12-10_00-59-17.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>/(<span class="number">1</span>+np.exp(-z))</span><br><span class="line"><span class="comment"># 逻辑回归的假设函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">h</span><span class="params">(mytheta,myX)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sigmoid(np.dot(myX,mytheta)) <span class="comment"># m一维向量</span></span><br><span class="line"><span class="comment"># 逻辑回归的代价函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">computeCost</span><span class="params">(theta,X,y,lamb = <span class="number">0</span>)</span>:</span></span><br><span class="line">    h_theta = h(theta,X)</span><br><span class="line">    left_hand = np.mean(-y*np.log(h_theta)-(<span class="number">1</span>-y)*np.log(<span class="number">1</span>-h_theta))</span><br><span class="line">    right_hand = np.sum(np.square(theta[<span class="number">1</span>:]))*lamb/(<span class="number">2</span>*len(X))</span><br><span class="line">    <span class="keyword">return</span> left_hand+right_hand</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">costGradient</span><span class="params">(theta,X,y,lamb=<span class="number">0</span>)</span>:</span></span><br><span class="line">    <span class="comment">#逻辑回归的梯度函数</span></span><br><span class="line">    first = (<span class="number">1</span>/len(X))*X.T @ (h(theta,X)-y) <span class="comment"># (n+1)一维向量</span></span><br><span class="line">    <span class="comment"># (n+1)一维向量</span></span><br><span class="line">    reg = np.concatenate([np.array([<span class="number">0</span>]),(lamb/len(X))*theta[<span class="number">1</span>:]]) </span><br><span class="line">    <span class="keyword">return</span> first+reg</span><br></pre></td></tr></table></figure>
<p>在代价函数及其梯度的求解方法确定后，就可以选择python第三方科学计算库scipy中的优化方法经过一定次数的迭代获得使代价函数最低的参数向量。<br>当然也可以自己采用梯度下降法求解。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scipy.optimize <span class="keyword">import</span> minimize</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">one_vs_all</span><span class="params">(X,y,lamb,K)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    采用一对多策略利用逻辑回归分类</span></span><br><span class="line"><span class="string">    参数：</span></span><br><span class="line"><span class="string">        X,特征矩阵，m*(n+1)，第一列为附加的0</span></span><br><span class="line"><span class="string">        y,真实分类向量，m一维向量</span></span><br><span class="line"><span class="string">        lamb，正则化用的lambda</span></span><br><span class="line"><span class="string">        K,分类总数</span></span><br><span class="line"><span class="string">    返回：</span></span><br><span class="line"><span class="string">        训练好的theta向量,K*(n+1)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    all_theta = zeros((K,X.shape[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(K):</span><br><span class="line">        init_theta = np.zeros(X.shape[<span class="number">1</span>])</span><br><span class="line">        y_new = np.array([<span class="number">1</span> <span class="keyword">if</span> i==num <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">for</span> num <span class="keyword">in</span> y])</span><br><span class="line">        ret = minimize(fun=computeCost,x0=init_theta,args=(X,y_new,lamb),</span><br><span class="line">                method=<span class="string">'TNC'</span>,jac=costGradient,options=&#123;<span class="string">'maxiter'</span>:<span class="number">100</span>,<span class="string">'disp'</span>:<span class="keyword">True</span>&#125;)</span><br><span class="line">        all_theta[i,:] = ret.x</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> all_theta</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">predictOneVsAll</span><span class="params">(all_theta,X)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    估计手写数字样本数据X的识别结果</span></span><br><span class="line"><span class="string">    参数：</span></span><br><span class="line"><span class="string">        all_theta,训练好的参数向量</span></span><br><span class="line"><span class="string">        X，待识别的样本数据</span></span><br><span class="line"><span class="string">    返回识别结果向量</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># m*K，每一行向量代表该行对应样本取这个下标数字的可能性</span></span><br><span class="line">    h = sigmoid(X @ all_theta.T) </span><br><span class="line">    h_argmax = np.argmax(h,axis=<span class="number">1</span>) <span class="comment"># 选取可能性最大的下标，表示样本取数字为该下标的可能性最大</span></span><br><span class="line">    <span class="keyword">return</span> h_argmax</span><br></pre></td></tr></table></figure>
<h3 id="测试算法"><a href="#测试算法" class="headerlink" title="测试算法"></a>测试算法</h3><p>下面代码从样本数据集中随机抽取占比为0.67的数据作为训练数据集，剩余数据用作测试。采用sklearn库中classification_report方法打印算法的查准率p，查全率r和f1-分数（综合考虑p和r的因子）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">trainingProp = <span class="number">0.67</span></span><br><span class="line">trainLen = int(len(X)*trainingProp)</span><br><span class="line">trainIndices = random.sample(range(len(X)),trainLen)</span><br><span class="line"></span><br><span class="line">trainingX = np.array([X[i,:] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(X)) <span class="keyword">if</span> i <span class="keyword">in</span> trainIndices])</span><br><span class="line">testX = np.array([X[i,:] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(X)) <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> trainIndices])</span><br><span class="line">trainingy = np.array([y[i] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(y)) <span class="keyword">if</span> i <span class="keyword">in</span> trainIndices])</span><br><span class="line">testy = np.array([y[i] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(y)) <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> trainIndices])</span><br><span class="line">print(<span class="string">"总样本数：%d\n训练样本数:%d,%d\n测试样本数%d,%d"</span>%(len(X),len(trainingX),len(trainingy),len(testX),len(testy)))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">总样本数：1593</span><br><span class="line">训练样本数:1067,1067</span><br><span class="line">测试样本数526,526</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_theta = one_vs_all(trainingX,trainingy,<span class="number">0.1</span>,<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">accuracy</span><span class="params">(all_theta,testX,realy)</span>:</span></span><br><span class="line">    predicty = predictOneVsAll(all_theta,testX)</span><br><span class="line">    print(classification_report(realy,predicty))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accuracy(all_theta,testX,testy)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">              precision    recall  f1-score   support</span><br><span class="line"></span><br><span class="line">           0       0.97      0.97      0.97        59</span><br><span class="line">           1       0.86      0.94      0.90        51</span><br><span class="line">           2       0.95      0.93      0.94        57</span><br><span class="line">           3       0.98      0.91      0.94        46</span><br><span class="line">           4       0.92      0.92      0.92        50</span><br><span class="line">           5       0.93      0.91      0.92        47</span><br><span class="line">           6       0.98      0.93      0.95        54</span><br><span class="line">           7       0.93      0.83      0.88        52</span><br><span class="line">           8       0.83      0.89      0.86        54</span><br><span class="line">           9       0.82      0.89      0.85        56</span><br><span class="line"></span><br><span class="line">   micro avg       0.91      0.91      0.91       526</span><br><span class="line">   macro avg       0.92      0.91      0.91       526</span><br><span class="line">weighted avg       0.92      0.91      0.91       526</span><br></pre></td></tr></table></figure>
<p>从上面可以看出，逻辑回归算法的查准率和查全率均在90%以上，这说明这种算法对于分类问题表现还不错</p>
<h2 id="采用神经网络BP算法识别"><a href="#采用神经网络BP算法识别" class="headerlink" title="采用神经网络BP算法识别"></a>采用神经网络BP算法识别</h2><p>采用三层神经网络，输入层包括256(16*16，不包括偏置1)个神经元，输出层包括10个神经元，隐层有25个(不包括偏置1)，如下图所示</p>
<p><img src="http://hjx-markdown-images.test.upcdn.net/2018/12/09/f6277d0a383ef5e9f581b400f3aa4de1.png" alt="Xnip2018-12-09_19-05-41.png"></p>
<h3 id="准备数据"><a href="#准备数据" class="headerlink" title="准备数据"></a>准备数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 特征矩阵在前面已经准备好</span></span><br><span class="line">y_another = y    <span class="comment"># 存储原来用单个数字表示的y，</span></span><br><span class="line">y = np.array(y_old) <span class="comment"># y的每个行向量表示一个数字</span></span><br></pre></td></tr></table></figure>
<p>下面两个函数分别实现将矩阵扁平化为向量和从向量中抽取矩阵的功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此处X已加偏置列</span></span><br><span class="line">inputLayerSize = len(X[<span class="number">0</span>])<span class="number">-1</span></span><br><span class="line">hiddenLayerSize = <span class="number">25</span></span><br><span class="line">outputLayerSize = <span class="number">10</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serialize</span><span class="params">(a,b)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    展开参数</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> np.r_[a.flatten(),b.flatten()]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deserialize</span><span class="params">(theta)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    从向量中提取theta1和theta2矩阵</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    t1 = theta[:(inputLayerSize+<span class="number">1</span>)*hiddenLayerSize].reshape(hiddenLayerSize,inputLayerSize+<span class="number">1</span>)</span><br><span class="line">    t2 = theta[(inputLayerSize+<span class="number">1</span>)*hiddenLayerSize:].reshape(outputLayerSize,hiddenLayerSize+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> t1,t2</span><br></pre></td></tr></table></figure>
<h4 id="前向反馈"><a href="#前向反馈" class="headerlink" title="前向反馈"></a>前向反馈</h4><p>在已知theta的情况下，通过前向反馈获得预测的各种分类可能性的向量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoid</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>/(<span class="number">1</span>+np.exp(-z))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">feed_forward</span><span class="params">(theta,X)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    theta为训练好的序列化的theta参数</span></span><br><span class="line"><span class="string">    inputLayerSize为输入层size,s1</span></span><br><span class="line"><span class="string">    hiddenLayerSize为隐层size,s2</span></span><br><span class="line"><span class="string">    outputLayerSize为输出层size,s3</span></span><br><span class="line"><span class="string">    X为特征矩阵，m*(s1+1)</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># t1, s2*(s1+1)</span></span><br><span class="line">    <span class="comment"># t2, s3*(s2+1)</span></span><br><span class="line">    t1,t2 = deserialize(theta)</span><br><span class="line">    a1 = X</span><br><span class="line">    z2 = a1 @ t1.T     <span class="comment"># m*s2</span></span><br><span class="line">    a2 = np.insert(sigmoid(z2),<span class="number">0</span>,<span class="number">1</span>,axis = <span class="number">1</span>) <span class="comment">#m*(s2+1)</span></span><br><span class="line">    z3 = a2 @ t2.T     <span class="comment"># m*s3</span></span><br><span class="line">    a3 = sigmoid(z3)   <span class="comment"># m*s3</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> a1,z2,a2,z3,a3</span><br></pre></td></tr></table></figure>
<h4 id="代价函数及其正则化"><a href="#代价函数及其正则化" class="headerlink" title="代价函数及其正则化"></a>代价函数及其正则化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cost</span><span class="params">(theta,X,y)</span>:</span></span><br><span class="line">    h = feed_forward(theta,X)[<span class="number">4</span>]</span><br><span class="line">    itemMat = -y*np.log(h)-(<span class="number">1</span>-y)*np.log(<span class="number">1</span>-h)</span><br><span class="line">    <span class="keyword">return</span> np.sum(itemMat)/len(X)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regularized_cost</span><span class="params">(theta,X,y,lamb=<span class="number">1</span>)</span>:</span></span><br><span class="line">    t1,t2 = deserialize(theta)</span><br><span class="line">    reg = np.sum(t1[:,<span class="number">1</span>:]**<span class="number">2</span>)+np.sum(t2[:,<span class="number">1</span>:]**<span class="number">2</span>) <span class="comment"># 正则项</span></span><br><span class="line">    <span class="keyword">return</span> lamb/(<span class="number">2</span>*len(X))*reg + cost(theta,X,y)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sigmoidGrad</span><span class="params">(z)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> sigmoid(z)*(<span class="number">1</span>-sigmoid(z))</span><br></pre></td></tr></table></figure>
<h4 id="神经网络梯度函数及其正则化"><a href="#神经网络梯度函数及其正则化" class="headerlink" title="神经网络梯度函数及其正则化"></a>神经网络梯度函数及其正则化</h4><p>Backpropagation反向传播<br><img src="http://hjx-markdown-images.test.upcdn.net/2018/12/09/3e3c3ed02f85a75a5612a914a7ef2244.png" alt="Xnip2018-12-09_21-02-49.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">costGradient</span><span class="params">(theta,X,y)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    unregularized gradient</span></span><br><span class="line"><span class="string">    返回，所有theta的梯度</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    t1,t2 = deserialize(theta)</span><br><span class="line">    a1,z2,a2,z3,a3 = feed_forward(theta,X)</span><br><span class="line">    d3 = a3-y <span class="comment"># m*s3</span></span><br><span class="line">    <span class="comment"># theta2的第一列数据不予考虑</span></span><br><span class="line">    d2 = d3 @ t2[:,<span class="number">1</span>:] * sigmoidGrad(z2) <span class="comment"># m*(s2+1)</span></span><br><span class="line">    D2 = d3.T@a2              <span class="comment"># s3*(s2+1)</span></span><br><span class="line">    D1 = d2.T@a1              <span class="comment"># s2*(s1+1)</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>/len(X)*serialize(D1,D2)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regularizedGrad</span><span class="params">(theta,X,y,l=<span class="number">1</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    正则化的梯度</span></span><br><span class="line"><span class="string">    返回，所有theta的梯度</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="comment"># D1 and t1, s2*(s1+1);D2 and t2, s3*(s2+1)</span></span><br><span class="line">    D1,D2 = deserialize(costGradient(theta,X,y))</span><br><span class="line">    t1,t2 = deserialize(theta)</span><br><span class="line">    t1[:,<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">    t2[:,<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">    reg_D1 = D1 + (l / len(X)) * t1</span><br><span class="line">    reg_D2 = D2 + (l / len(X)) * t2</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> serialize(D1,D2)</span><br></pre></td></tr></table></figure>
<h4 id="梯度检测"><a href="#梯度检测" class="headerlink" title="梯度检测"></a>梯度检测</h4><p>因为反向传播算法代价函数和梯度函数代码编写过程中可能存在bug，故使用数值计算梯度与反向传播算法计算的梯度进行比较，以验证反向传播算法代价函数和梯度函数代码的正确性。不过这个函数运行起来超级慢，这里只贴代码，不展示运行结果了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gradientCheck</span><span class="params">(theta,X,y,e)</span>:</span></span><br><span class="line">    numericGrad = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(theta)):</span><br><span class="line">        plus = theta.copy()</span><br><span class="line">        minus = theta.copy()</span><br><span class="line">        plus[i] += e</span><br><span class="line">        minus[i] += e</span><br><span class="line">        grad_i = (regularized_cost(plus,X,y)-regularized_cost(minus,X,y))/(<span class="number">2</span>*e)</span><br><span class="line">        numericGrad.append(grad_i)</span><br><span class="line">    </span><br><span class="line">    numericGrad = np.array(numericGrad)</span><br><span class="line">    analyticGrad = regularizedGrad(theta, X, y)</span><br><span class="line">    diff = np.linalg.norm(numericGrad - analyticGrad) / np.linalg.norm(numericGrad + analyticGrad)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'If your backpropagation implementation is correct,\nthe relative difference will \</span></span><br><span class="line"><span class="string">          be smaller than 10e-9 (assume epsilon=0.0001).\nRelative Difference: &#123;&#125;\n'</span>.format(diff))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initTheta = randomInit((inputLayerSize+<span class="number">1</span>)*hiddenLayerSize+(hiddenLayerSize+<span class="number">1</span>)*outputLayerSize)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradientCheck(initTheta,X,y,<span class="number">0.0001</span>)</span><br></pre></td></tr></table></figure>
<h3 id="测试算法-1"><a href="#测试算法-1" class="headerlink" title="测试算法"></a>测试算法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">randomInit</span><span class="params">(size)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    随机初始化size尺寸的矩阵</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> np.random.uniform(<span class="number">-0.12</span>, <span class="number">0.12</span>, size)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nn_training</span><span class="params">(X,y)</span>:</span></span><br><span class="line">    init_theta = randomInit((inputLayerSize+<span class="number">1</span>)*hiddenLayerSize+(hiddenLayerSize+<span class="number">1</span>)*outputLayerSize)</span><br><span class="line">    res = minimize(fun=regularized_cost,</span><br><span class="line">                  x0=init_theta,</span><br><span class="line">                  args=(X,y),</span><br><span class="line">                  method=<span class="string">'TNC'</span>,</span><br><span class="line">                  jac=regularizedGrad,</span><br><span class="line">                  options=&#123;<span class="string">"maxiter"</span>:<span class="number">500</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">trainingy = np.array([y[i] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(y)) <span class="keyword">if</span> i <span class="keyword">in</span> trainIndices])</span><br><span class="line">res = nn_training(trainingX,trainingy)</span><br><span class="line">res</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    fun: 0.9114611628633325</span><br><span class="line">    jac: array([ 2.96364632e-03, -1.62797300e-04,  2.89863853e-04, ...,</span><br><span class="line">       9.59179838e-04,  1.10862199e-06, -4.78441900e-03])</span><br><span class="line">message: &apos;Converged (|f_n-f_(n-1)| ~= 0)&apos;</span><br><span class="line">   nfev: 163</span><br><span class="line">    nit: 11</span><br><span class="line"> status: 1</span><br><span class="line">success: True</span><br><span class="line">      x: array([ 0.        ,  0.44110449,  0.17106004, ..., -0.34636188,</span><br><span class="line">       0.6146963 , -0.88931194])</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> classification_report</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">accuracyBP</span><span class="params">(theta,X,y)</span>:</span></span><br><span class="line">    h = feed_forward(res.x,X)[<span class="number">4</span>]</span><br><span class="line">    y_pred = np.argmax(h,axis=<span class="number">1</span>)</span><br><span class="line">    print(classification_report(y,y_pred))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">testy = np.array([y_another[i] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(y_another)) <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> trainIndices])</span><br><span class="line">accuracyBP(res.x,testX,testy)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">              precision    recall  f1-score   support</span><br><span class="line"></span><br><span class="line">           0       0.93      0.98      0.95        53</span><br><span class="line">           1       0.89      0.83      0.86        58</span><br><span class="line">           2       0.96      0.90      0.93        50</span><br><span class="line">           3       0.84      0.88      0.86        52</span><br><span class="line">           4       0.95      0.85      0.90        48</span><br><span class="line">           5       0.93      0.90      0.91        48</span><br><span class="line">           6       0.93      0.95      0.94        58</span><br><span class="line">           7       0.98      0.89      0.93        54</span><br><span class="line">           8       0.74      0.96      0.83        52</span><br><span class="line">           9       0.86      0.79      0.82        53</span><br><span class="line"></span><br><span class="line">   micro avg       0.89      0.89      0.89       526</span><br><span class="line">   macro avg       0.90      0.89      0.89       526</span><br><span class="line">weighted avg       0.90      0.89      0.89       526</span><br></pre></td></tr></table></figure>
<p>从上面可以看出,查准率约为0.9，查全率约为0.89，比逻辑回归算法稍有不如。但是实际上神经网络的可调性很强，适用范围也更大。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="hjx051013.github.io/2018/12/08/k-nearest-neighbors/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jiaxinhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追风少年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/08/k-nearest-neighbors/" itemprop="url">k近邻算法实战</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-08T16:36:48+08:00">
                2018-12-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/机器学习实战/" itemprop="url" rel="index">
                    <span itemprop="name">机器学习实战</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/12/08/k-nearest-neighbors/" class="leancloud_visitors" data-flag-title="k近邻算法实战">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
                <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  2.7k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  11
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="k-近邻算法概述"><a href="#k-近邻算法概述" class="headerlink" title="k-近邻算法概述"></a>k-近邻算法概述</h2><p>k-近邻算法的工作原理是：</p>
<blockquote>
<p>存在一个样本数据集，也即训练集，其中的每个样本数据对存在一个对应标签，也即样本的分类。当输入没有标签的新样本后，我们通过将新数据的每个特征与样本数据集中对应的特征进行比较，然后算法提取样本集中特征最相似数据（最近邻）的分类标签。通常做法是提取特征向量最相近的前k个数据，取其中出现次数最多的分类，作为输入新样本的分类标签</p>
</blockquote>
<p>用一个简单的例子来描述一下k-近邻算法的一般流程</p>
<h3 id="准备用pyhton导入数据"><a href="#准备用pyhton导入数据" class="headerlink" title="准备用pyhton导入数据"></a>准备用pyhton导入数据</h3><p>创建一个名为kNN的Python模块，在kNN.py中增加下列代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createDataSet</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    以四个点(1,1.1),(1,1),(0,0),(0,0.1)为例，其标签分分别是'A','B','C','D'</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    group = array([[<span class="number">1.0</span>,<span class="number">1.1</span>],[<span class="number">1.0</span>,<span class="number">1.0</span>],[<span class="number">0</span>,<span class="number">0</span>],[<span class="number">0</span>,<span class="number">0.1</span>]])</span><br><span class="line">    labels = [<span class="string">'A'</span>,<span class="string">'A'</span>,<span class="string">'B'</span>,<span class="string">'B'</span>]</span><br><span class="line">    <span class="keyword">return</span> group,labels</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">group,labels = createDataSet()</span><br><span class="line">print(group)</span><br><span class="line">print(labels)</span><br></pre></td></tr></table></figure>
<pre><code>[[1.  1.1]
 [1.  1. ]
 [0.  0. ]
 [0.  0.1]]
[&#39;A&#39;, &#39;A&#39;, &#39;B&#39;, &#39;B&#39;]
</code></pre><h3 id="实施kNN算法"><a href="#实施kNN算法" class="headerlink" title="实施kNN算法"></a>实施kNN算法</h3><p>kNN算法的伪代码如下:</p>
<ol>
<li>计算已知类别数据集中的点与当前点之间的距离</li>
<li>按照距离递增次序排序</li>
<li>选取与当前点距离最小的k个点</li>
<li>确定当前k个点所在类别的出现频率</li>
<li>返回前k个点出现频率最高的类别作为当前点的预测分类</li>
</ol>
<p>pyhton函数classify0如下所示：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">classify0</span><span class="params">(inX,dataSet,labels,k)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    输入参数为inX（待分类的数据特征向量），dataSet(训练数据多个特征向量构成的矩阵)，labels(训练数据特征向量对应的标签向量)，k（k值）</span></span><br><span class="line"><span class="string">    返回为inX的预估的标签</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    dataSetSize = dataSet.shape[<span class="number">0</span>]</span><br><span class="line">    diffMat = tile(inX,(dataSetSize,<span class="number">1</span>))-dataSet  <span class="comment"># 新数据与训练数据作差</span></span><br><span class="line">    sqDiffMat = diffMat**<span class="number">2</span></span><br><span class="line">    sqDistances = sqDiffMat.sum(axis = <span class="number">1</span>)  <span class="comment"># 对差平方矩阵进行每行求和</span></span><br><span class="line">    distances = sqDistances**<span class="number">0.5</span>       <span class="comment"># 开平方根，为新数据向量与训练数据向量的距离</span></span><br><span class="line">    sortedDistanceIndices = distances.argsort()  <span class="comment">#按照距离从小到大排序，返回下标向量</span></span><br><span class="line">    classCount = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(k):</span><br><span class="line">        <span class="comment"># 统计前k个点对应的标签，插入classCount字典中</span></span><br><span class="line">        voteIlabel = labels[sortedDistanceIndices[i]]</span><br><span class="line">        classCount[voteIlabel] = classCount.get(voteIlabel,<span class="number">0</span>)+<span class="number">1</span></span><br><span class="line">    sortedClassCount = sorted(classCount.items(),key = operator.itemgetter(<span class="number">1</span>),reverse=<span class="keyword">True</span>)  <span class="comment"># 利用字典中的value值进行从大到小的排序</span></span><br><span class="line">    <span class="keyword">return</span> sortedClassCount[<span class="number">0</span>][<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>上述程序使用欧式距离公式，计算两个向量$xA$和$xB$之间的距离:</p>
<script type="math/tex; mode=display">d=\sqrt {(xA_0-xB_0)^2+(xA_1-xB_1)^2}</script><p>对数据点[0,0]进行分类，它实际上属于B类（画个图就知道了）。运行下列代码，确实是B</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classify0([<span class="number">0</span>,<span class="number">0</span>],group,labels,<span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<pre><code>&#39;B&#39;
</code></pre><h2 id="使用k近邻算法改进约会网站的配对效果"><a href="#使用k近邻算法改进约会网站的配对效果" class="headerlink" title="使用k近邻算法改进约会网站的配对效果"></a>使用k近邻算法改进约会网站的配对效果</h2><p>海伦将约会网站上的约会对象分为三种人，</p>
<ul>
<li>不喜欢的人</li>
<li>魅力一般的人</li>
<li>极具魅力的人<br>我们需要根据已有数据采用k近邻算法，来帮助海伦将约会对象划分到确切的分类中。<h3 id="大致步骤"><a href="#大致步骤" class="headerlink" title="大致步骤"></a>大致步骤</h3></li>
</ul>
<ol>
<li>收集数据：获得海伦给定的对象数据特征和分类标签</li>
<li>准备数据：使用pyhton解析文本文件</li>
<li>分析数据：使用matplotlib画二维扩散图</li>
<li>训练算法：k近邻算法用不着训练数据</li>
<li>测试算法：使用海伦提供的部分数据作为测试样本</li>
<li>使用算法：产生简单的命令行程序，使得海伦通过输入一些数据来判断对方是否为自己喜欢的类型<h3 id="准备数据"><a href="#准备数据" class="headerlink" title="准备数据"></a>准备数据</h3>下载海伦提供的数据。查看数据，可以看出，每个样本数据占据一行，每一行有四列，前三列是3种特征：</li>
</ol>
<ul>
<li>每年获得的飞行常客里程数</li>
<li>玩视频游戏所消耗的时间百分比</li>
<li>每周消耗的冰淇淋公升数<br>第四列是海伦给这个样本定义的标签，有’largeDoses’,’smallDoses’,’didntLike’</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!wget https://github.com/pbharrin/machinelearninginaction/raw/master/Ch02/datingTestSet.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!cat datingTestSet.txt</span><br></pre></td></tr></table></figure>
<p>在kNN.py中创建名为file2matrix的函数，以此来处理输入格式问题。file2matrix输入文件名，返回特征数据矩阵和标签向量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file2matrix</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据文件名读取数据，返回特征数据矩阵和标签向量</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    dic = &#123;<span class="string">'didntLike'</span>:<span class="number">1</span>,<span class="string">'smallDoses'</span>:<span class="number">2</span>,<span class="string">'largeDoses'</span>:<span class="number">3</span>&#125;</span><br><span class="line">    fr = open(filename)</span><br><span class="line">    arrayOLines = fr.readlines() <span class="comment"># 以列表形式存储文本数据，列表元素为字符串</span></span><br><span class="line">    numberOfLines = len(arrayOLines)</span><br><span class="line">    returnMat = np.zeros((numberOfLines,<span class="number">3</span>)) <span class="comment"># 返回的特征数据矩阵</span></span><br><span class="line">    classLabelVector = []     <span class="comment"># 返回的标签向量</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> arrayOLines:</span><br><span class="line">        line = line.strip() <span class="comment"># remove leading and trailing whitespace</span></span><br><span class="line">        listFromLine = line.split(<span class="string">'\t'</span>)</span><br><span class="line">        returnMat[index,:] = listFromLine[<span class="number">0</span>:<span class="number">3</span>]</span><br><span class="line">        classLabelVector.append(dic[listFromLine[<span class="number">-1</span>]])</span><br><span class="line">        index+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> returnMat,classLabelVector</span><br></pre></td></tr></table></figure>
<p>在执行上述代码后，可调用file2matrix函数将文件’datingTestSet.txt’导入到内存中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">datingDataMat,datingLabels = file2matrix(<span class="string">'datingTestSet.txt'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="分析数据"><a href="#分析数据" class="headerlink" title="分析数据"></a>分析数据</h3><p>利用Matplotlib制作原始数据的散点图</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">fig = plt.figure(figsize=(<span class="number">10</span>,<span class="number">15</span>))</span><br><span class="line">ax1 = fig.add_subplot(<span class="number">311</span>) <span class="comment"># 设定figure里面有多少个子图和子图位置</span></span><br><span class="line">ax1.scatter(datingDataMat[:,<span class="number">0</span>],datingDataMat[:,<span class="number">1</span>],<span class="number">15.0</span>*np.array(datingLabels),<span class="number">15.0</span>*np.array(datingLabels))</span><br><span class="line">ax1.set_title(<span class="string">"Charisma scattering plot"</span>)</span><br><span class="line">ax1.set_xlabel(<span class="string">"Flying milages"</span>)</span><br><span class="line">ax1.set_ylabel(<span class="string">"Time percentage of playing games"</span>)</span><br><span class="line"></span><br><span class="line">ax2 = fig.add_subplot(<span class="number">312</span>) <span class="comment"># 设定figure里面有多少个子图和子图位置</span></span><br><span class="line">ax2.scatter(datingDataMat[:,<span class="number">0</span>],datingDataMat[:,<span class="number">2</span>],<span class="number">15.0</span>*np.array(datingLabels),<span class="number">15.0</span>*np.array(datingLabels))</span><br><span class="line">ax2.set_title(<span class="string">"Charisma scattering plot"</span>)</span><br><span class="line">ax2.set_xlabel(<span class="string">"Flying milages"</span>)</span><br><span class="line">ax2.set_ylabel(<span class="string">"Weekly consumption of ice cream/liter"</span>)</span><br><span class="line">ax3 = fig.add_subplot(<span class="number">313</span>) <span class="comment"># 设定figure里面有多少个子图和子图位置</span></span><br><span class="line">ax3.scatter(datingDataMat[:,<span class="number">1</span>],datingDataMat[:,<span class="number">2</span>],<span class="number">15.0</span>*np.array(datingLabels),<span class="number">15.0</span>*np.array(datingLabels))</span><br><span class="line">ax3.set_title(<span class="string">'Charisma scattering plot'</span>)</span><br><span class="line">ax3.set_xlabel(<span class="string">'Time percentage of playing games'</span>)</span><br><span class="line">ax3.set_ylabel(<span class="string">'Weekly consumption of ice cream/liter'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="http://hjx-markdown-images.test.upcdn.net/2018/12/08/cebf487775d2ade34214ae98aac63c00.png" alt="K-nearest neighbor algorithm_15_0.png"></p>
<h3 id="准备数据：归一化数值"><a href="#准备数据：归一化数值" class="headerlink" title="准备数据：归一化数值"></a>准备数据：归一化数值</h3><p>显然，因为飞行常客里程数远远大于玩视频游戏时间占比与每周消费冰淇淋公升数，而海伦认为这三种特征是同样重要的，所以需要对特征树进行归一化处理。通过下面公式将任意范围的特征值转为0到1区间的值：</p>
<script type="math/tex; mode=display">newValue = (oldValue-min)/(max-min)</script><p>下面是归一化特征值的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">autoNorm</span><span class="params">(dataSet)</span>:</span></span><br><span class="line">    minVals = dataSet.min(<span class="number">0</span>) <span class="comment"># 对每一列求最小值，得到一个有三个元素的向量</span></span><br><span class="line">    maxVals = dataSet.max(<span class="number">0</span>) <span class="comment"># 对每一列求最大值，得到一个有三个元素的向量</span></span><br><span class="line">    ranges = maxVals-minVals <span class="comment"># 获得每一列最大值与最小值的差值</span></span><br><span class="line">    normDataSet = np.zeros(np.shape(dataSet))</span><br><span class="line">    m = dataSet.shape[<span class="number">0</span>]  <span class="comment">#数据集有多少行</span></span><br><span class="line">    normDataSet = dataSet - np.tile(minVals,(m,<span class="number">1</span>))</span><br><span class="line">    normDataSet = normDataSet/tile(ranges,(m,<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> normDataSet,ranges,minVals</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">normMat,ranges,minVals = autoNorm(datingDataMat)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(normMat[<span class="number">0</span>:<span class="number">5</span>])</span><br><span class="line">print(ranges)</span><br><span class="line">print(minVals)</span><br></pre></td></tr></table></figure>
<pre><code>[[0.44832535 0.39805139 0.56233353]
 [0.15873259 0.34195467 0.98724416]
 [0.28542943 0.06892523 0.47449629]
 [0.82320073 0.62848007 0.25248929]
 [0.42010233 0.07982027 0.0785783 ]]
[9.1273000e+04 2.0919349e+01 1.6943610e+00]
[0.       0.       0.001156]
</code></pre><h3 id="测试算法"><a href="#测试算法" class="headerlink" title="测试算法"></a>测试算法</h3><p>为了测试分类器效果，我们定义了一个datingClassTest函数，该函数是自包含的，选用海伦提供数据的前10%作为测试数据，后90%作为训练集数据。代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">datingClassTest</span><span class="params">()</span>:</span></span><br><span class="line">    hoRatio = <span class="number">0.10</span></span><br><span class="line">    datingDataMat,datingDataLabels = file2matrix(<span class="string">'datingTestSet.txt'</span>)</span><br><span class="line">    normMat,ranges,minVals = autoNorm(datingDataMat)</span><br><span class="line">    m = normMat.shape[<span class="number">0</span>]</span><br><span class="line">    numTestVecs = int(m*hoRatio)</span><br><span class="line">    errCoount = <span class="number">0</span>    <span class="comment"># 预测错误向量个数</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(numTestVecs):</span><br><span class="line">        <span class="comment"># 遍历所有的测试向量</span></span><br><span class="line">        classifierResult = classify0(normMat[i,:],normMat[numTestVecs:m,:],datingLabels[numTestVecs:m],<span class="number">3</span>)</span><br><span class="line">        <span class="comment"># print("the classifier came back with:%d, the real answer is:%d"%(classifierResult,datingLabels[i]))</span></span><br><span class="line">        <span class="keyword">if</span> classifierResult!=datingLabels[i]:</span><br><span class="line">            errCoount += <span class="number">1</span></span><br><span class="line">    print(<span class="string">"the total error rate is: %f"</span>%(errCoount/float(numTestVecs)))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">datingClassTest()</span><br></pre></td></tr></table></figure>
<pre><code>the total error rate is: 0.050000
</code></pre><h3 id="使用算法：构建完整系统"><a href="#使用算法：构建完整系统" class="headerlink" title="使用算法：构建完整系统"></a>使用算法：构建完整系统</h3><p>设计一个函数，能够询问约会对象的特征数据，然后给出预估的分类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">classifyPerson</span><span class="params">()</span>:</span></span><br><span class="line">    resultList = [<span class="string">'not at all'</span>,<span class="string">'in small doses'</span>,<span class="string">'in large doses'</span>]</span><br><span class="line">    percentageTats = float(input(<span class="string">"percentage of time spent in playing video games?"</span>))</span><br><span class="line">    ffMiles = float(input(<span class="string">"frequent flier miles earned each year?"</span>))</span><br><span class="line">    icecream = float(input(<span class="string">"liters of ice cream cosumed each week?"</span>))</span><br><span class="line">    datingDataMat,datingLabels = file2matrix(<span class="string">'datingTestSet.txt'</span>)</span><br><span class="line">    normMat,ranges,minVals = autoNorm(datingDataMat)</span><br><span class="line">    inArr = array([ffMiles,percentageTats,icecream])</span><br><span class="line">    classifierResult = classify0((inArr-minVals)/ranges,normMat,datingLabels,<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">"You will propably like this person %s"</span>%resultList[int(classifierResult)<span class="number">-1</span>])</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">classifyPerson()</span><br></pre></td></tr></table></figure>
<pre><code>percentage of time spent in playing video games?10
frequent flier miles earned each year?10000
liters of ice cream cosumed each week?0.5
You will propably like this person in small doses
</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">以上让人觉得十分容易看懂，事实上k-近邻算法本身就是一个非常简单的算法。接下来看看，如何在二进制存储的图像数据上使用kNN。</span><br></pre></td></tr></table></figure>
<h2 id="手写识别数字"><a href="#手写识别数字" class="headerlink" title="手写识别数字"></a>手写识别数字</h2><p>需要识别的数字已经通过软件转成宽高32x32的黑白图像，这里直接使用图像的文本格式</p>
<h3 id="准备数据-将图像转化为测试向量"><a href="#准备数据-将图像转化为测试向量" class="headerlink" title="准备数据:将图像转化为测试向量"></a>准备数据:将图像转化为测试向量</h3><p>执行以下指令，获取并解压数据文件，文件夹中包含两个文件夹trainingDigits和testDigits，分别对应训练数据和测试数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">!wget https://github.com/pbharrin/machinelearninginaction/raw/master/Ch02/digits.zip</span><br><span class="line">!unzip digits.zip</span><br></pre></td></tr></table></figure>
<p>首先编写一个函数根据手写数字的文件名读入数据将32x32的矩阵转成一个1x1024的向量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img2vector</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    参数为一个图像文本文件的名字</span></span><br><span class="line"><span class="string">    返回1x1024的向量</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    returnVect = zeros((<span class="number">1</span>,<span class="number">1024</span>))</span><br><span class="line">    fr = open(filename)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">        lineStr = fr.readline()</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">            returnVect[<span class="number">0</span>,<span class="number">32</span>*i+j] = int(lineStr[j])</span><br><span class="line">    <span class="keyword">return</span> returnVect</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(img2vector(<span class="string">"testDigits/0_0.txt"</span>))</span><br></pre></td></tr></table></figure>
<pre><code>[[0. 0. 0. ... 0. 0. 0.]]
</code></pre><h3 id="测试算法：使用k近邻算法实现手写数字的识别"><a href="#测试算法：使用k近邻算法实现手写数字的识别" class="headerlink" title="测试算法：使用k近邻算法实现手写数字的识别"></a>测试算法：使用k近邻算法实现手写数字的识别</h3><p>下面实现一个函数classifyDigitTest，输入数字图像转化来的1x1024向量，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> listdir</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">classifyDigitTest</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 首先列出trainingDigits下的所有文件名，文件数为m</span></span><br><span class="line">    <span class="comment"># 根据trainingDigits下的所有文件构造m*1024的特征矩阵和，m*1的标签向量</span></span><br><span class="line">    <span class="comment"># 列出testDigits下的所有文件名，文件数为testN</span></span><br><span class="line">    <span class="comment"># 对testDigits文件夹下的进行循环判断，以获得算法的手写数字识别错误率</span></span><br><span class="line">        <span class="comment"># 调用classify0获得digitVect的结果标签</span></span><br><span class="line">        <span class="comment"># 有文件名名可获得digitVect的真实标签，对比，若不等errorCount++</span></span><br><span class="line">    <span class="comment"># 获得手写识别错误率</span></span><br><span class="line">    trainingFiles = listdir(<span class="string">'trainingDigits'</span>)</span><br><span class="line">    m = len(trainingFiles)</span><br><span class="line">    trainingDataMat = np.zeros((m,<span class="number">1024</span>))</span><br><span class="line">    trainingLabelsVect = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(m):</span><br><span class="line">        trainingFileName = trainingFiles[i]</span><br><span class="line">        realLabel = int(trainingFileName.split(<span class="string">'.'</span>)[<span class="number">0</span>].split(<span class="string">'_'</span>)[<span class="number">0</span>])</span><br><span class="line">        trainingDataMat[i,:] = img2vector(<span class="string">'trainingDigits/'</span>+trainingFileName) <span class="comment"># 构造特征矩阵第i行</span></span><br><span class="line">        trainingLabelsVect.append(realLabel)</span><br><span class="line">    testFiles = listdir(<span class="string">'testDigits'</span>)</span><br><span class="line">    testN = len(testFiles)</span><br><span class="line">    errCount = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(testN):</span><br><span class="line">        testFileName = testFiles[i]</span><br><span class="line">        testDataVect = img2vector(<span class="string">'testDigits/'</span>+testFileName)  <span class="comment"># 获得测试文件的特征向量</span></span><br><span class="line">        testRealLabel = int(testFileName.split(<span class="string">'.'</span>)[<span class="number">0</span>].split(<span class="string">'_'</span>)[<span class="number">0</span>]) <span class="comment"># 获得测试文件名中的数据标签</span></span><br><span class="line">        testLabel = classify0(testDataVect,trainingDataMat,trainingLabelsVect,<span class="number">3</span>) <span class="comment"># 采用k近邻算法估计测试文件的标签</span></span><br><span class="line">        <span class="comment"># print("test data file:%s,predicted label:%s,real label:%s"%(testFileName,testLabel,testRealLabel))</span></span><br><span class="line">        <span class="keyword">if</span> testLabel!=testRealLabel:</span><br><span class="line">            errCount+=<span class="number">1</span></span><br><span class="line">    print(<span class="string">"model accuracy:%.5f"</span>%(<span class="number">1</span>-errCount/testN))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start = tiem</span><br><span class="line">classifyDigitTest()</span><br></pre></td></tr></table></figure>
<pre><code> model accuracy:0.99
</code></pre><p>实际上，使用这个算法效率太低，而且训练集数据越大，耗时越多，我们需要为每个测试向量做m次距离计算(m是训练集样本数)，每个距离计算包括1024个维度的浮点数计算。k近邻算法没有训练出一个模型出来，而是直接将输入与所有的训练数据一一比较。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="hjx051013.github.io/2018/12/08/python-passParam/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jiaxinhuang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="追风少年">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/08/python-passParam/" itemprop="url">python传递参数究竟是值传递还是引用传递</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-08T15:57:27+08:00">
                2018-12-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/12/08/python-passParam/" class="leancloud_visitors" data-flag-title="python传递参数究竟是值传递还是引用传递">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
                <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  876
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  3
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>首先还是应该科普下函数参数传递机制，传值和传引用是什么意思？</p>
<p>　　 函数参数传递机制问题在本质上是调用函数（过程）和被调用函数（过程）在调用发生时进行通信的方法问题。基本的参数传递机制有两种：值传递和引用传递。</p>
<p>　　值传递（passl-by-value）过程中，被调函数的形式参数作为被调函数的局部变量处理，即在堆栈中开辟了内存空间以存放由主调函数放进来的实参的值，从而成为了实参的一个副本。值传递的特点是被调函数对形式参数的任何操作都是作为局部变量进行，不会影响主调函数的实参变量的值。</p>
<p>　　引用传递(pass-by-reference)过程中，被调函数的形式参数虽然也作为局部变量在堆栈中开辟了内存空间，但是这时存放的是由主调函数放进来的实参变量的地址。被调函数对形参的任何操作都被处理成间接寻址，即通过堆栈中存放的地址访问主调函数中的实参变量。正因为如此，被调函数对形参做的任何操作都影响了主调函数中的实参变量。</p>
<p>那么,python究竟是怎样的呢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os.path  </span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(c)</span>:</span></span><br><span class="line">    print(<span class="string">"test before "</span>)</span><br><span class="line">    print(id(c))</span><br><span class="line">    c+=<span class="number">2</span></span><br><span class="line">    print(<span class="string">"test after"</span>)</span><br><span class="line">    print(id(c))</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printIt</span><span class="params">(t)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(t)):</span><br><span class="line">        print(t[i])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    a=<span class="number">2</span></span><br><span class="line">    print(<span class="string">"main before invoke test"</span>)</span><br><span class="line">    print(id(a))</span><br><span class="line">    n=test(a)</span><br><span class="line">    print(<span class="string">"main afterf invoke test"</span>)</span><br><span class="line">    print(a)</span><br><span class="line">    print(id(a))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">main before invoke test</span><br><span class="line">test before </span><br><span class="line">test after +</span><br><span class="line">main afterf invoke test</span><br><span class="line">39601564</span><br></pre></td></tr></table></figure>
<p>从上可以看出，传参数进去时，传得是引用，因为参数地址没变。但是对传入参数赋值后，其地址就发生了变化。基于这个例子画了个图表示</p>
<p><img src="http://hjx-markdown-images.test.upcdn.net/2018/12/08/5c76d4645b932a417ded382c0ec1e38d.jpg" alt="849009-20160314194651474-1039918478.jpg"></p>
<p>那么python传递参数传得真是引用，然后传参的值在被调函数内被修改也不影响主调函数的实参变量的值？有传入对象可变与不可变的说法，<br>对于可变对象，在被调函数内修改传参会影响主调函数的实参变量，对于不可变对象修改传参则不会改变主调函数实参的值，因为修改不可变对象<br>实际上是另开辟内存重新赋值并让传参变量指向该内存。看下面例子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os.path  </span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(list2)</span>:</span></span><br><span class="line">    print(<span class="string">"test before "</span>)</span><br><span class="line">    print(id(list2))</span><br><span class="line">    list2[<span class="number">1</span>]=<span class="number">30</span></span><br><span class="line">    print(<span class="string">"test after +"</span>)</span><br><span class="line">    print(id(list2))</span><br><span class="line">    <span class="keyword">return</span> list2</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printIt</span><span class="params">(t)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(t)):</span><br><span class="line">        print(t[i])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    list1=[<span class="string">"loleina"</span>,<span class="number">25</span>,<span class="string">'female'</span>]</span><br><span class="line">    print(<span class="string">"main before invoke test"</span>)</span><br><span class="line">    print(id(list1))</span><br><span class="line">    list3=test(list1)</span><br><span class="line">    print(<span class="string">"main afterf invoke test"</span>)</span><br><span class="line">    print(list1)</span><br><span class="line">    print(id(list1))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">main before invoke test</span><br><span class="line">4485568072</span><br><span class="line">test before </span><br><span class="line">4485568072</span><br><span class="line">test after +</span><br><span class="line">4485568072</span><br><span class="line">main afterf invoke test</span><br><span class="line">[&apos;loleina&apos;, 30, &apos;female&apos;]</span><br><span class="line">4485568072</span><br></pre></td></tr></table></figure>
<p>结论：python不允许程序员选择采用传值还是传引用。Python参数传递采用的肯定是“传对象引用”的方式。这种方式相当于传值和传引用的一种综合。如果函数收到的是一个可变对象（比如<strong>字典或者列表</strong>）的引用，就能修改对象的原始值－－相当于通过“传引用”来传递对象。如果函数收到的是一个不可变对象（比如<strong>数字、字符或者元组</strong>）的引用，就不能直接修改原始对象－－相当于通过“传值’来传递对象。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="jiaxinhuang">
            
              <p class="site-author-name" itemprop="name">jiaxinhuang</p>
              <p class="site-description motion-element" itemprop="description">选择，机会，勤奋，积极</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/hjx051013" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/qq_23034951" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-heartbeat"></i></a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/cba40b8b6293" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-spinner"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jiaxinhuang</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点共计字数&#58;</span>
    
    <span title="Site words total count">20.1k</span>
  
  
  
</div>

<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



-->


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> 访问人数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> 总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("vAbDr03l8J5eJO758KBCoF5d-gzGzoHsz", "jAR7LhUqbbzuo3B5hA2vtyPm");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
